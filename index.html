<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>转 住专 29.0 - Performance & Precision</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #f8fafc; color: #0f172a; }
        .layout { display: grid; grid-template-columns: 300px 1fr; min-height: 100vh; }
        .sidebar { background: white; border-left: 1px solid #e2e8f0; padding: 24px; position: sticky; top: 0; height: 100vh; overflow-y: auto; z-index: 50; display: flex; flex-direction: column; gap: 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.03); }
        .main { padding: 32px; overflow-y: auto; }

        /* KPI Cards */
        .card { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); border-color: #cbd5e1; }
        .stat-val { font-size: 2rem; font-weight: 800; line-height: 1; margin-top: 5px; }
        .stat-lbl { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; }
        .stat-sub { font-size: 0.8rem; font-weight: 600; margin-top: 4px; }

        /* Tables */
        .table-wrap { background: white; border-radius: 8px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .data-table th { background: #f8fafc; color: #475569; font-weight: 700; text-align: right; padding: 12px 16px; border-bottom: 2px solid #e2e8f0; white-space: nowrap; position: sticky; top: 0; z-index: 10; }
        .data-table td { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; color: #334155; vertical-align: middle; }
        .data-table tr:hover { background-color: #f8fafc; }

        /* Tabs */
        .tabs-nav { display: flex; gap: 8px; border-bottom: 1px solid #e2e8f0; margin-bottom: 24px; padding-bottom: 1px; overflow-x: auto; }
        .tab-btn { padding: 10px 16px; border-radius: 6px 6px 0 0; font-weight: 600; color: #64748b; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
        .tab-btn.active { background: white; color: #2563eb; border-bottom-color: #2563eb; }
        .badge { background: #e2e8f0; color: #475569; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; }
        .tab-btn.active .badge { background: #dbeafe; color: #1e40af; }

        /* Components */
        .upload-box { border: 2px dashed #cbd5e1; background: #f8fafc; border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; }
        .upload-box:hover { background: #f1f5f9; border-color: #3b82f6; }
        select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.85rem; background: #f8fafc; margin-bottom: 8px; }
        label { display: block; font-size: 0.75rem; font-weight: 700; color: #475569; margin-bottom: 2px; }
        .hidden { display: none !important; }
        
        /* Badges & Tags */
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; border: 1px solid transparent; display: inline-flex; align-items: center; gap: 4px; cursor: help; }
        .tag-reg-bad { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        
        .reason-chain { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .reason-local { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }
        .reason-break { background: #fef3c7; color: #b45309; border: 1px solid #fcd34d; }

        .q-ok { background: #dcfce7; color: #15803d; border: 1px solid #86efac; } 
        .q-bad { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; } 
        .q-warn { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }

        /* Tooltip */
        .has-tooltip { position: relative; }
        .has-tooltip:hover::after {
            content: attr(data-tip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: #fff; padding: 8px 12px; border-radius: 8px;
            font-size: 0.75rem; line-height: 1.4; white-space: normal; width: 220px; text-align: center;
            z-index: 1000; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); pointer-events: none; margin-bottom: 8px;
        }
        .has-tooltip:hover::before {
            content: ''; position: absolute; bottom: 100%; left: 50%; margin-left: -5px; margin-bottom: 3px;
            border-width: 5px; border-style: solid; border-color: #1e293b transparent transparent transparent; z-index: 1000;
        }
    </style>
</head>
<body>

<div class="layout">
    <aside class="sidebar">
        <div>
            <h1 class="text-2xl font-black text-slate-800 flex items-center gap-2">
                <i class="fas fa-chart-line text-blue-600"></i> 转 住专
            </h1>
            <p class="text-xs text-slate-500 font-bold mt-1">专住 29.0 | Performance & Precision</p>
        </div>

        <div id="step-upload" class="upload-box" onclick="document.getElementById('fileIn').click()">
            <div class="font-bold text-sm text-slate-700"><i class="fas fa-file-upload text-xl mb-2 block text-blue-500"></i> 注 拽抓 爪注</div>
            <div id="file-status" class="text-xs text-slate-400 mt-1">Excel / CSV</div>
            <input type="file" id="fileIn" class="hidden" accept=".csv, .xlsx" onchange="loadFile(event)">
        </div>

        <div id="step-map" class="hidden bg-white border border-slate-200 p-4 rounded-xl shadow-sm">
            <h3 class="font-bold text-sm mb-3 border-b pb-2">驻 注转</h3>
            <label>转专 (A)</label><select id="c-date"></select>
            <label> (C)</label><select id="c-driver"></select>
            <label>住专 转 (D)</label><select id="c-plan"></select>
            <label>住专 爪注 (E)</label><select id="c-act"></select>
            <label>转 转 (F)</label><select id="c-start"></select>
            <label>转 驻注 (H)</label><select id="c-start-act"></select>
            <label>住 驻注 (I)</label><select id="c-end-act"></select>
            <label>住驻专 专</label><select id="c-veh"></select>
            <label>转专 拽</label><select id="c-desc"></select>

            <button onclick="run()" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold text-sm mt-2 hover:bg-blue-700 shadow transition">
                爪注 转
            </button>
        </div>

        <div class="mt-auto space-y-2">
            <button onclick="exportExcel()" class="w-full bg-green-600 text-white py-3 rounded-lg text-sm font-bold hover:bg-green-700 shadow flex items-center justify-center gap-2">
                <i class="fas fa-file-excel"></i> 爪 拽住
            </button>
            <button onclick="downloadHTML()" class="w-full bg-slate-800 text-white py-3 rounded-lg text-sm font-bold hover:bg-slate-900 shadow flex items-center justify-center gap-2">
                <i class="fas fa-download"></i> 砖专 拽抓 HTML
            </button>
        </div>
    </aside>

    <main class="main">
        <div id="empty" class="h-full flex flex-col items-center justify-center text-slate-400">
            <i class="fas fa-database text-6xl mb-4 opacity-20"></i>
            <h2 class="text-xl font-bold">注专转 </h2>
            <p class="text-sm"> 注 转 拽抓 转 转</p>
        </div>

        <div id="dash" class="hidden flex flex-col gap-6">
            <div id="debug-info" class="text-xs text-slate-400 text-left dir-ltr"></div>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="card border-t-4 border-red-500">
                    <div class="stat-lbl">专转 168 (砖专转)</div>
                    <div class="stat-val text-red-600" id="k-reg">0</div>
                </div>
                <div class="card border-t-4 border-green-500">
                    <div class="stat-lbl">拽转 爪</div>
                    <div class="stat-val text-green-600" id="k-pun">-</div>
                    <div class="stat-sub text-slate-500" id="k-pun-sub">-</div>
                </div>
                <div class="card border-t-4 border-blue-500">
                    <div class="stat-lbl">砖专转 转拽转</div>
                    <div class="stat-val text-blue-600" id="k-good-breaks">-</div>
                </div>
                <div class="card border-t-4 border-orange-500">
                    <div class="stat-lbl">驻驻转 </div>
                    <div class="stat-val text-orange-600" id="k-over">0</div>
                </div>
                <div class="card border-t-4 border-purple-500">
                    <div class="stat-lbl"> 驻注</div>
                    <div class="stat-val text-purple-700" id="k-driver">0</div>
                </div>
            </div>

            <div class="tabs-nav">
                <div class="tab-btn active" onclick="tab('daily', this)"> </div>
                <div class="tab-btn" onclick="tab('reg', this)"> 专转 168 <span class="badge" id="b-reg">0</span></div>
                <div class="tab-btn" onclick="tab('break', this)"> 转 砖专转 <span class="badge" id="b-break">0</span></div>
                <div class="tab-btn" onclick="tab('pun', this)">憋 拽转 <span class="badge" id="b-pun">0</span></div>
                <div class="tab-btn" onclick="tab('split', this)"> 驻转 <span class="badge" id="b-split">0</span></div>
                <div class="tab-btn" onclick="tab('over', this)">锔 驻驻转 <span class="badge" id="b-over">0</span></div>
            </div>

            <div id="v-daily" class="view">
                <div class="table-wrap"><table id="t-daily" class="data-table"><thead><tr><th>转专 </th><th></th><th>专转 168</th><th>砖专转 拽转</th><th>% 砖专</th><th>驻驻转</th><th>拽转</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="v-reg" class="view hidden">
                <div class="p-4 bg-red-50 border border-red-100 rounded mb-4 text-sm text-red-900">
                    <i class="fas fa-filter"></i> 爪转 专拽 专转 砖  砖爪注 砖专 住专.
                </div>
                <div class="table-wrap max-h-[600px] overflow-auto"><table id="t-reg" class="data-table"><thead><tr><th>转专</th><th></th><th>住 专</th><th>驻专 </th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="v-break" class="view hidden">
                <div class="table-wrap max-h-[600px] overflow-auto"><table id="t-break" class="data-table"><thead><tr><th>转专</th><th>转</th><th>爪注</th><th></th><th>住住 砖专</th><th>驻专</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="v-pun" class="view hidden">
                <div class="bg-white border border-slate-200 p-3 rounded-lg mb-3 flex flex-wrap gap-4 items-center text-xs shadow-sm">
                    <span class="font-bold">拽专:</span>
                    <div class="flex items-center gap-1"><span class="tag reason-local"> 拽</span>   驻  专</div>
                    <div class="flex items-center gap-1"><span class="tag reason-chain"> 专专</span> 注 住注 拽转</div>
                    <div class="flex items-center gap-1"><span class="tag reason-break"> 砖专 (拽)</span> 专 住专 砖 (专转 )</div>
                </div>
                <div class="table-wrap max-h-[600px] overflow-auto"><table id="t-pun" class="data-table"><thead><tr><th>转专</th><th>拽</th><th></th><th>转</th><th>爪注</th><th>专</th><th>住</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="v-split" class="view hidden">
                <div class="table-wrap max-h-[600px] overflow-auto"><table id="t-split" class="data-table"><thead><tr><th>转专</th><th>住专</th><th>驻 专砖</th><th></th><th>专</th><th>驻专 </th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="v-over" class="view hidden">
                <div class="table-wrap max-h-[600px] overflow-auto"><table id="t-over" class="data-table"><thead><tr><th>专转</th><th>转专</th><th>住专</th><th></th><th>住 1</th><th>转 2</th><th>驻驻</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>
    </main>
</div>

<script>
    let raw = [], heads = [];
    let lastAnalysis = null; 

    // --- Config & Helpers ---
    const REG_RULES = {
        minBreakForAccum: 15, slidingWindow: 240, reqBreakInWindow: 30,
        maxWorkTime: 720, maxDutySpan: 960, longBreakThreshold: 540
    };
    const REASONS_DESC = {
        '拽': '  住驻拽  驻住拽,  爪 专.',
        '专专': '专 注拽 住 专 砖 住注 拽转.',
        '砖专 (拽)': '住专 砖 转 (砖专),      专 (专转 拽转).',
        '驻': '住注 专砖 砖  住专 (驻).'
    };
    const QUALITY_DESC = {
        'ok': '驻 转拽 .',
        'late': '驻 砖专 专.',
        'early': '爪 拽转 .',
        'overlap': '驻驻 爪驻驻 (驻转 -5 拽) 注 住注 拽转.'
    };

    const norm = (v) => (v == null ? '' : String(v).trim());
    const parseTime = (val) => {
        if (!val && val !== 0) return null;
        if (typeof val === 'number') {
            if (val > 0 && val < 1) return Math.round(val * 1440);
            if (val >= 1 && val < 1440) return Math.round(val);
            return null;
        }
        if (typeof val === 'string') {
            const p = val.trim().split(':');
            if (p.length >= 2) return parseInt(p[0], 10) * 60 + parseInt(p[1], 10);
        }
        return null;
    };
    const parseDateStr = (val) => {
        if (!val) return '';
        if (typeof val === 'number' && val > 40000) {
            const d = new Date(Math.round((val - 25569) * 86400 * 1000));
            return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
        }
        return val.toString();
    };
    const fmtTime = m => {
        if (m == null) return '';
        let t = m;
        while (t >= 1440) t -= 1440;
        return `${Math.floor(t / 60).toString().padStart(2, '0')}:${(t % 60).toString().padStart(2, '0')}`;
    };
    const fmtDur = m => `${Math.floor(m / 60)}:${(m % 60).toString().padStart(2, '0')}`;
    const getDayName = d => {
        if (!d) return '';
        const p = d.split(/[/-]/);
        if (p.length === 3) {
            const dt = new Date(p[2], p[1] - 1, p[0]);
            if (!isNaN(dt.getDay())) return ['\'','\'','\'','\'','\'','\'','砖\''][dt.getDay()];
        }
        return '';
    };
    const getBreakKey = (d, drv, sp) => `${d}|${drv}|${sp ?? ''}`;

    // --- Loading ---
    function loadFile(e) {
        const f = e.target.files[0]; if (!f) return;
        document.getElementById('file-status').innerText = "注...";
        const isCSV = f.name.toLowerCase().endsWith('.csv');
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                let workbook;
                if (isCSV) workbook = XLSX.read(e.target.result, { type: 'string' });
                else workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                raw = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: "" });
                if (!raw || raw.length === 0) throw new Error("拽抓 专拽");
                heads = raw[0];
                initMap();
                document.getElementById('step-upload').classList.add('hidden');
                document.getElementById('step-map').classList.remove('hidden');
            } catch (err) { alert("砖: " + err.message); }
        };
        if (isCSV) reader.readAsText(f); else reader.readAsArrayBuffer(f);
    }

    function initMap() {
        const m = [{id:'c-date',d:0},{id:'c-driver',d:2},{id:'c-plan',d:3},{id:'c-act',d:4},{id:'c-start',d:5},{id:'c-start-act',d:7},{id:'c-end-act',d:8},{id:'c-veh',d:12},{id:'c-desc',d:11}];
        const k = {'c-date':['转专'],'c-driver':['','注'],'c-plan':['转','住专'],'c-act':['爪注'],'c-start':['转 转','转'],'c-start-act':['转 爪注','转-爪注'],'c-end-act':['住 爪注'],'c-veh':['专'],'c-desc':['转专','拽']};
        m.forEach(x => {
            const el = document.getElementById(x.id); el.innerHTML = '';
            if (x.id.includes('veh') || x.id.includes('desc')) el.add(new Option('()', -1));
            let f = -1;
            heads.forEach((h, i) => { el.add(new Option(`[${i}] ${h}`, i)); if (f === -1 && h && k[x.id] && k[x.id].some(w => h.toString().includes(w))) f = i; });
            if (f === -1 && x.d !== -1 && heads[x.d]) f = x.d;
            if (f !== -1) el.value = f;
        });
    }

    // --- Core Logic ---
    function run() {
        const C = {
            date: +document.getElementById('c-date').value,
            drv: +document.getElementById('c-driver').value,
            plan: +document.getElementById('c-plan').value,
            act: +document.getElementById('c-act').value,
            sPlan: +document.getElementById('c-start').value,
            sAct: +document.getElementById('c-start-act').value,
            eAct: +document.getElementById('c-end-act').value,
            veh: +document.getElementById('c-veh').value,
            desc: +document.getElementById('c-desc').value
        };

        const res = { daily: {}, lates: [], splits: [], overlaps: [], breaks: [], regulations: [], drivers: new Set(), totalGoodBreaks: 0, totalBadBreaks: 0 };
        const driverTimeline = {};
        const dutyGroups = {};
        const dutyStats = {};
        const brokenDrivers = new Set();
        const overlapCountMap = {};
        
        // **PERFORMANCE**: Map for fast O(1) retrieval
        const breaksMap = new Map(); 

        let processedRows = 0;

        raw.slice(1).forEach(row => {
            const dStr = parseDateStr(row[C.date]);
            const drv = row[C.drv];
            const planRaw = row[C.plan];
            const actRaw = row[C.act];
            
            // Normalize for strict comparison
            const planNorm = norm(planRaw);
            const actNorm = norm(actRaw);

            const sP = parseTime(row[C.sPlan]);
            const sA = parseTime(row[C.sAct]);
            const eA = parseTime(row[C.eAct]);
            const veh = C.veh !== -1 ? row[C.veh] : null;
            const desc = C.desc !== -1 ? row[C.desc] : '';

            // Require minimal data
            if (sP === null && sA === null) return;
            processedRows++;

            // Detect Break
            if (planNorm !== actNorm && planNorm !== '' && actNorm !== '') {
                brokenDrivers.add(`${drv}_${dStr}`);

                let status = 'ok', txt = '转拽', det = '驻 转拽';
                if (sP !== null && sA !== null) {
                    const diff = sA - sP;
                    if (diff > 5) { status = 'bad'; txt = '专'; det = `专 ${diff} 拽'`; }
                    else if (diff < -2) { status = 'warn'; txt = '拽'; det = `拽 ${Math.abs(diff)} 拽'`; }
                }

                const breakKeyStart = sP ?? sA;
                const breakObj = { date: dStr, plan: planNorm, act: actNorm, drv, desc, status, statusText: txt, details: det, sP, sA, sPKey: breakKeyStart };
                // Store in Map for O(1) access later
                breaksMap.set(getBreakKey(dStr, drv, breakKeyStart), breakObj);
                res.breaks.push(breakObj);
            }

            // Daily Stats
            if (!res.daily[dStr]) res.daily[dStr] = { date: dStr, breaksGood: 0, breaksBad: 0, overlaps: 0, splits: 0, tripCount: 0, lateCount: 0, regViolations: 0, punTripCount: 0, totalBreaks: 0, drivers: new Set() };
            const day = res.daily[dStr];
            day.tripCount++; // Count TOTAL rows for % Break
            if (planNorm !== actNorm && planNorm !== '' && actNorm !== '') day.totalBreaks++;
            if (drv) { day.drivers.add(drv); res.drivers.add(drv); }

            // Timeline
            let realEnd = eA;
            if (sA !== null && eA !== null && eA < sA) realEnd += 1440; // Simple midnight check

            if (drv && sA !== null && realEnd !== null) {
                const k = `${drv}_${dStr}`;
                if (!driverTimeline[k]) driverTimeline[k] = [];
                driverTimeline[k].push({ sP, sA, eA: realEnd, plan: planNorm, act: actNorm, desc, date: dStr, sPKey: (sP ?? sA) });
            }

            // Duty Grouping
            if (planNorm) {
                const k = `${dStr}_${planNorm}`;
                if (!dutyStats[k]) dutyStats[k] = { drv: new Set(), veh: new Set(), trips: [] };
                if (drv) dutyStats[k].drv.add(drv);
                if (veh) dutyStats[k].veh.add(veh);
                if (sA !== null) dutyStats[k].trips.push({ s: sA, d: drv, v: veh });

                if (!dutyGroups[k]) dutyGroups[k] = [];
                if (realEnd !== null) {
                    let st = (sP ?? sA);
                    if (st != null && realEnd >= 1440 && st < 360) st += 1440; // Night Shift Fix for Overlaps
                    dutyGroups[k].push({ start: st, end: realEnd, drv, desc, duty: planNorm, date: dStr, e1Str: fmtTime(realEnd) });
                }
            }
        });

        document.getElementById('debug-info').innerText = `注 ${processedRows} 砖专转.  ${res.drivers.size} .`;

        // --- 2. Analyze Timelines (Reg 168 & Punctuality) ---
        Object.keys(driverTimeline).forEach(k => {
            const trips = driverTimeline[k];
            // Sort by actual start
            trips.sort((a, b) => a.sA - b.sA);
            
            // Night shift fix for timeline
            if (trips.length > 1) {
                const span = trips[trips.length - 1].eA - trips[0].sA;
                if (span > 1200) {
                    trips.forEach(t => { if (t.sA < 360) { t.sA += 1440; t.eA += 1440; if (t.sP) t.sP += 1440; } });
                    trips.sort((a, b) => a.sA - b.sA);
                }
            }

            const [drv, date] = k.split('_');
            
            // Regulation 168 - Filter: Only for broken drivers
            if (brokenDrivers.has(k)) checkRegulation168(drv, date, trips, res);

            // Punctuality & Context
            for (let i = 0; i < trips.length; i++) {
                const trip = trips[i];
                res.daily[date].punTripCount++;
                
                // Lookup Break Context (O(1))
                if (trip.plan !== trip.act) {
                    const brk = breaksMap.get(getBreakKey(date, drv, trip.sPKey));
                    if (brk && i > 0 && (trip.sA - trips[i-1].eA < 5)) {
                        brk.status = 'bad';
                        brk.statusText = '驻驻';
                        brk.details += ' (爪  拽转)';
                    }
                }

                if (trip.sP !== null) {
                    const diff = trip.sA - trip.sP;
                    if (diff > 5 && diff < 120) {
                        res.daily[date].lateCount++;
                        let reason = '拽', css = 'reason-local', suf = '';
                        
                        // Classification Logic
                        if (i > 0 && trips[i-1].eA > trip.sP) {
                            reason = '专专'; css = 'reason-chain'; suf = '(驻驻)';
                        } else if (trip.plan !== trip.act) {
                            // If break exists -> Break Local
                            if (breaksMap.has(getBreakKey(date, drv, trip.sPKey))) {
                                reason = '砖专 (拽)'; css = 'reason-break';
                            }
                        }
                        
                        res.lates.push({
                            date, line: trip.desc, drv, plan: fmtTime(trip.sP), act: fmtTime(trip.sA),
                            diff, reason, css, suffix: suf
                        });
                    }
                }
            }
        });

        // Sum Breaks Stats
        res.breaks.sort((a, b) => (a.status === 'ok' ? 1 : -1) - (b.status === 'ok' ? 1 : -1));
        res.breaks.forEach(b => {
            if (b.status === 'ok') { res.totalGoodBreaks++; if (res.daily[b.date]) res.daily[b.date].breaksGood++; }
            else { res.totalBadBreaks++; if (res.daily[b.date]) res.daily[b.date].breaksBad++; }
        });

        // Overlaps
        Object.values(dutyGroups).forEach(trips => {
            trips.sort((a, b) => a.start - b.start);
            for (let i = 0; i < trips.length - 1; i++) {
                if (trips[i].end > trips[i+1].start + 1) {
                    const uniqueKey = `${trips[i].duty}_${trips[i].e1Str}_${fmtTime(trips[i+1].start)}`;
                    overlapCountMap[uniqueKey] = (overlapCountMap[uniqueKey] || 0) + 1;
                    res.overlaps.push({
                        date: trips[i].date, duty: trips[i].duty, drv: trips[i].drv,
                        e1: trips[i].e1Str, s2: fmtTime(trips[i+1].start), gap: trips[i].end - trips[i+1].start,
                        uniqueKey: uniqueKey
                    });
                    res.daily[trips[i].date].overlaps++;
                }
            }
        });
        res.overlaps.forEach(o => o.rec = overlapCountMap[o.uniqueKey]);

        // Splits
        Object.entries(dutyStats).forEach(([key, s]) => {
            if (s.drv.size > 2) {
                const [date, duty] = key.split('_');
                s.trips.sort((a, b) => a.s - b.s);
                let swap = null, firstD = s.trips[0].d;
                for (let i = 1; i < s.trips.length; i++) if (s.trips[i].d !== firstD) { swap = s.trips[i].s; break; }
                res.splits.push({
                    date, duty, dc: s.drv.size, vc: s.veh.size,
                    start: s.trips[0].s, swap, list: Array.from(s.drv).join(', ')
                });
                res.daily[date].splits++;
            }
        });

        lastAnalysis = res;
        render(res);
    }

    // --- Regulation 168 Logic ---
    function checkRegulation168(drv, date, trips, res) {
        if (trips.length === 0) return;
        const dutyStart = trips[0].sA; const dutyEnd = trips[trips.length - 1].eA; const span = dutyEnd - dutyStart;
        
        if (span > REG_RULES.maxDutySpan) {
            addReg(res, date, drv, '专转 专 ', ` 注 砖 ${fmtDur(span)} (${fmtTime(dutyStart)}-${fmtTime(dutyEnd)})`);
        }
        
        let work = 0, breaks = [];
        for (let i = 0; i < trips.length; i++) {
            work += (trips[i].eA - trips[i].sA);
            if (i < trips.length - 1) {
                const gap = trips[i+1].sA - trips[i].eA;
                // FIX: No negative gap allowed
                if (gap >= REG_RULES.minBreakForAccum) breaks.push({ s: trips[i].eA, e: trips[i+1].sA });
                else work += Math.max(0, gap);
            }
        }
        if (work > REG_RULES.maxWorkTime) {
            addReg(res, date, drv, '专转  ', `注  ${fmtDur(work)} (转专 12)`);
        }
        
        if (span > REG_RULES.longBreakThreshold) {
            let win = 0; const ws = dutyStart + 60, we = dutyStart + 480;
            breaks.forEach(b => { const is = Math.max(b.s, ws), ie = Math.min(b.e, we); if (ie > is) win += (ie - is); });
            if (win < 45) addReg(res, date, drv, '驻住拽 专', ` ${fmtTime(ws)}-${fmtTime(we)} 爪注 专拽 ${win} 拽'`);
        }
        
        for (let t = dutyStart + 240; t <= dutyEnd; t += 30) {
            const winStart = t - 240; let breakSum = 0;
            breaks.forEach(b => { const is = Math.max(b.s, winStart), ie = Math.min(b.e, t); if (ie > is) breakSum += (ie - is); });
            if (breakSum < 30) {
                addReg(res, date, drv, ' 专爪驻', ` ${fmtTime(winStart)}-${fmtTime(t)} 爪专 专拽 ${breakSum} 拽' `);
                break;
            }
        }
    }
    function addReg(res, date, drv, type, det) { res.regulations.push({ date, drv, type, details: det }); res.daily[date].regViolations++; }

    // --- Render & Export ---
    function render(d) {
        document.getElementById('step-map').classList.add('hidden');
        document.getElementById('empty').classList.add('hidden');
        document.getElementById('dash').classList.remove('hidden');

        const totalP = Object.values(d.daily).reduce((a, b) => a + b.punTripCount, 0);
        const totalL = d.lates.length;
        const rate = totalP ? ((1 - totalL / totalP) * 100).toFixed(1) : '0.0';

        document.getElementById('k-reg').innerText = d.regulations.length;
        document.getElementById('k-pun').innerText = rate + '%';
        document.getElementById('k-pun-sub').innerText = `${totalL} 专转 转 ${totalP}`;
        document.getElementById('k-good-breaks').innerText = d.totalGoodBreaks;
        document.getElementById('k-over').innerText = d.overlaps.length;
        document.getElementById('k-driver').innerText = d.drivers.size;

        document.getElementById('b-reg').innerText = d.regulations.length;
        document.getElementById('b-pun').innerText = totalL;
        document.getElementById('b-break').innerText = d.breaks.length;
        document.getElementById('b-split').innerText = d.splits.length;
        document.getElementById('b-over').innerText = d.overlaps.length;

        const fill = (id, html) => document.querySelector(`#${id} tbody`).innerHTML = html;
        
        fill('t-reg', d.regulations.map(r => `<tr><td>${r.date} <span class="day-badge">${getDayName(r.date)}</span></td><td class="font-bold">${r.drv}</td><td><span class="tag tag-reg-bad">${r.type}</span></td><td class="text-xs">${r.details}</td></tr>`).join(''));
        
        fill('t-daily', Object.values(d.daily).sort((a, b) => String(a.date).localeCompare(String(b.date))).map(r => {
            const breakPct = r.tripCount ? ((r.totalBreaks / r.tripCount) * 100).toFixed(1) : '0.0';
            const pctClass = parseFloat(breakPct) > 15 ? 'text-orange-600 font-black' : '';
            const pun = r.punTripCount ? ((1 - r.lateCount / r.punTripCount) * 100).toFixed(1) + '%' : '-';
            return `<tr><td class="font-bold">${r.date} <span class="day-badge">${getDayName(r.date)}</span></td><td>${r.drivers.size}</td><td class="text-red-600 font-bold">${r.regViolations}</td><td class="text-red-600 font-bold">${r.breaksBad}</td><td class="${pctClass}">${breakPct}%</td><td class="text-orange-500 font-bold">${r.overlaps}</td><td class="font-bold">${pun}</td></tr>`;
        }).join(''));

        fill('t-break', d.breaks.map(b => {
            const css = b.status === 'ok' ? 'q-ok' : (b.status === 'bad' ? 'q-bad' : 'q-warn');
            const tip = QUALITY_DESC[b.status] || '';
            return `<tr><td>${b.date}</td><td class="font-bold font-mono">${b.plan}</td><td class="font-mono">${b.act}</td><td>${b.drv}</td><td><span class="tag ${css} has-tooltip" data-tip="${tip}">${b.statusText}</span></td><td class="text-xs">${b.details}</td></tr>`;
        }).join(''));
        
        fill('t-split', d.splits.map(s => `<tr><td>${s.date} ${getDayName(s.date)}</td><td class="font-bold text-purple-700">${s.duty}</td><td>${s.swap ? fmtTime(s.swap) : '-'}</td><td class="font-bold text-lg text-center">${s.dc}</td><td class="text-center">${s.vc}</td><td class="text-xs text-slate-500">${s.list}</td></tr>`).join(''));
        
        fill('t-pun', d.lates.map(l => `<tr><td>${l.date} ${getDayName(l.date)}</td><td class="text-xs text-slate-500">${l.line}</td><td>${l.drv}</td><td>${l.plan}</td><td class="font-bold text-red-600">${l.act}</td><td>${l.diff}</td><td><span class="tag ${l.css} has-tooltip" data-tip="${REASONS_DESC[l.reason]}">${l.reason}</span></td></tr>`).join(''));
        
        fill('t-over', d.overlaps.map(o => `<tr><td class="font-bold">${o.rec}</td><td>${o.date}</td><td class="font-mono font-bold">${o.duty}</td><td>${o.drv}</td><td>${o.e1}</td><td>${o.s2}</td><td class="font-bold text-red-600 dir-ltr">${o.gap}</td></tr>`).join(''));
    }

    function exportExcel() {
        if (!lastAnalysis) return alert(' 转');
        const wb = XLSX.utils.book_new();
        const d = lastAnalysis;
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d.regulations.map(r => ({ "转专": r.date, "": r.drv, "住": r.type, "驻专": r.details }))), "专转 168");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(Object.values(d.daily).map(r => ({ 
            "转专": r.date, "": getDayName(r.date), "专转 168": r.regViolations, 
            "砖专转 拽转": r.breaksBad, "% 砖专": r.tripCount ? ((r.totalBreaks / r.tripCount) * 100).toFixed(1) : "0.0",
            "拽转": r.punTripCount ? (100 * (1 - r.lateCount / r.punTripCount)).toFixed(1) : "" 
        }))), "住 ");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d.breaks), "转 砖专转");
        XLSX.writeFile(wb, "sadran_v29.xlsx");
    }

    function tab(id, el) {
        document.querySelectorAll('.view').forEach(e => e.classList.add('hidden'));
        document.getElementById('v-' + id).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
    }
    
    function filter() {
        const input = document.getElementById('search');
        if (!input) return;
        const v = input.value.toLowerCase();
        document.querySelectorAll('tbody tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(v) ? '' : 'none');
    }

    function downloadHTML() {
        const html = document.documentElement.outerHTML;
        const blob = new Blob([html], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'sadran_v29.html';
        a.click();
    }
</script>
</body>
</html>
