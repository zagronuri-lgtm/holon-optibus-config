<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניתוח יעילות תפעולית - דקות/ק"מ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); min-height: 100vh; }
        .upload-zone { border: 2px dashed #94a3b8; transition: all 0.3s; }
        .upload-zone:hover, .upload-zone.dragover { border-color: #3b82f6; background: #eff6ff; }
        .upload-zone.has-file { border-color: #22c55e; background: #f0fdf4; }
        .layout { display: grid; grid-template-columns: 320px 1fr; min-height: calc(100vh - 80px); }
        .sidebar { background: white; border-left: 1px solid #e2e8f0; padding: 24px; position: sticky; top: 80px; height: calc(100vh - 80px); overflow-y: auto; display: flex; flex-direction: column; gap: 16px; box-shadow: -5px 0 15px rgba(0,0,0,0.03); }
        .main { padding: 32px; overflow-y: auto; }
        .card { background: white; border-radius: 12px; padding: 16px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-val { font-size: 1.75rem; font-weight: 800; line-height: 1; margin-top: 4px; }
        .stat-lbl { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #64748b; }
        .stat-sub { font-size: 0.75rem; margin-top: 4px; }
        .compare-box { display: flex; gap: 8px; align-items: center; padding: 8px 12px; background: #f8fafc; border-radius: 8px; margin-top: 8px; }
        .compare-label { font-size: 0.65rem; color: #64748b; }
        .compare-val { font-size: 0.85rem; font-weight: 700; }
        .table-wrap { background: white; border-radius: 8px; border: 1px solid #e2e8f0; overflow: hidden; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .data-table th { background: #f8fafc; color: #475569; font-weight: 700; text-align: right; padding: 10px 12px; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; white-space: nowrap; }
        .data-table td { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; }
        .data-table tr:hover { background: #f8fafc; }
        .clickable { cursor: pointer; color: #2563eb; text-decoration: underline; }
        .clickable:hover { color: #1d4ed8; }
        .tabs-nav { display: flex; gap: 4px; border-bottom: 1px solid #e2e8f0; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { padding: 10px 14px; font-weight: 600; font-size: 0.85rem; color: #64748b; cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; background: white; }
        .badge { background: #e2e8f0; color: #475569; font-size: 0.65rem; padding: 2px 6px; border-radius: 8px; }
        .tab-btn.active .badge { background: #dbeafe; color: #1e40af; }
        .status-ok { background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .status-warn { background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .status-bad { background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 16px; max-width: 900px; width: 95%; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
        .modal-close { cursor: pointer; color: #64748b; font-size: 1.5rem; }
        .modal-close:hover { color: #1e293b; }
        .breakdown-bar { height: 24px; border-radius: 4px; overflow: hidden; display: flex; }
        .breakdown-segment { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 700; color: white; min-width: 30px; }
        .activity-row { display: grid; grid-template-columns: 100px 1fr 80px 80px; gap: 12px; padding: 8px 12px; border-bottom: 1px solid #f1f5f9; align-items: center; }
        .activity-row.with-duty { grid-template-columns: 100px 1fr 60px 50px 70px; }
        .activity-row:hover { background: #f8fafc; }
        .activity-pt { background: #dcfce7; }
        .activity-non-pt { background: #fef3c7; }
        .gap-card { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; margin-bottom: 16px; }
        .gap-title { font-size: 1rem; font-weight: 700; color: #1e293b; margin-bottom: 12px; }
        .gap-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
        .gap-item { background: #f8fafc; border-radius: 8px; padding: 12px; text-align: center; }
        .gap-item-value { font-size: 1.5rem; font-weight: 800; }
        .gap-item-label { font-size: 0.7rem; color: #64748b; margin-top: 4px; }
        .hidden { display: none !important; }
        .pagination { display: flex; gap: 8px; align-items: center; justify-content: center; padding: 12px; }
        .pagination button { padding: 6px 10px; border-radius: 6px; border: 1px solid #e2e8f0; background: #fff; font-size: 0.8rem; }
        .pagination button:disabled { opacity: 0.4; cursor: not-allowed; }
        .mapping-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } .sidebar { position: relative; height: auto; } }
    </style>
</head>
<body>
    <header class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-gauge-high text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800">ניתוח יעילות תפעולית</h1>
                    <p class="text-xs text-slate-500">דקות/ק"מ | תכנון vs ביצוע | יעילות נהגים</p>
                </div>
            </div>
            <div id="status-indicator" class="text-sm text-slate-500"><i class="fas fa-circle-info ml-1"></i> טען קבצים להתחלה</div>
        </div>
    </header>

    <div id="upload-section" class="max-w-4xl mx-auto p-6">
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="card">
                <h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-file-csv text-green-500"></i> קובץ ביצוע (סדרן) <span class="text-red-500">*</span>
                </h3>
                <div id="exec-zone" class="upload-zone rounded-lg p-6 text-center cursor-pointer" onclick="document.getElementById('exec-file').click()">
                    <i class="fas fa-cloud-upload-alt text-3xl text-slate-400 mb-2"></i>
                    <p class="text-sm text-slate-600">גרור קובץ CSV או לחץ לבחירה</p>
                    <p id="exec-filename" class="text-xs text-slate-400 mt-1"></p>
                </div>
                <input type="file" id="exec-file" class="hidden" accept=".csv" onchange="handleFile(this, 'exec')">
            </div>
            <div class="card">
                <h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-file-csv text-blue-500"></i> קובץ תכנון (אופטיבוס) <span class="text-slate-400 text-xs">(אופציונלי)</span>
                </h3>
                <div id="plan-zone" class="upload-zone rounded-lg p-6 text-center cursor-pointer" onclick="document.getElementById('plan-file').click()">
                    <i class="fas fa-cloud-upload-alt text-3xl text-slate-400 mb-2"></i>
                    <p class="text-sm text-slate-600">גרור קובץ CSV או לחץ לבחירה</p>
                    <p id="plan-filename" class="text-xs text-slate-400 mt-1"></p>
                </div>
                <input type="file" id="plan-file" class="hidden" accept=".csv" onchange="handleFile(this, 'plan')">
            </div>
        </div>
        <div class="card bg-blue-50 border-blue-200 mb-6">
            <h4 class="font-bold text-blue-800 mb-2"><i class="fas fa-info-circle ml-1"></i> מידע על הנוסחאות</h4>
            <div class="text-sm text-blue-700 space-y-1">
                <p><strong>דקות/ק"מ</strong> = (שעות תשלום נהג × 60) / ק"מ תח"צ</p>
                <p><strong>יעילות נהג</strong> = זמן תח"צ / זמן עבודה כולל (יעד: ≥75%)</p>
                <p><strong>תח"צ</strong> = נסיעות עם מספר קו (service_trip באופטיבוס)</p>
            </div>
        </div>

        <div id="mapping-section" class="card bg-slate-50 border-slate-200 mb-6 hidden">
            <h4 class="font-bold text-slate-700 mb-2"><i class="fas fa-sliders-h ml-1"></i> מיפוי עמודות</h4>
            <p class="text-xs text-slate-500 mb-4">אם הכותרות שונות, בחר את העמודות המתאימות.</p>
            <div class="mapping-grid" id="mapping-grid"></div>
        </div>

        <div id="manual-km-section" class="card bg-amber-50 border-amber-200 mb-6 hidden">
            <h4 class="font-bold text-amber-800 mb-2"><i class="fas fa-exclamation-triangle ml-1"></i> לא נמצאה עמודת מרחק בקובץ הביצוע</h4>
            <p class="text-sm text-amber-700 mb-3">הזן ק"מ תח"צ ידנית או השאר ריק לשימוש בנתוני התכנון:</p>
            <div class="flex gap-4 items-center">
                <div class="flex-1">
                    <label class="text-xs text-amber-600">ק"מ תח"צ ביצוע (אופציונלי)</label>
                    <input type="number" id="manual-km" placeholder="לדוגמא: 30000" class="w-full p-2 border rounded-lg text-sm mt-1">
                </div>
                <div class="text-xs text-amber-600 mt-4">
                    <span id="planning-km-hint"></span>
                </div>
            </div>
        </div>

        <button id="analyze-btn" onclick="runAnalysis()" disabled class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-4 rounded-xl text-lg font-bold hover:from-blue-700 hover:to-blue-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2">
            <i class="fas fa-calculator"></i> הפעל ניתוח
        </button>
    </div>

    <div id="results-section" class="hidden">
        <div class="layout">
            <aside class="sidebar">
                <div>
                    <h2 class="text-lg font-black text-slate-800 flex items-center gap-2"><i class="fas fa-chart-pie text-blue-600"></i> תוצאות</h2>
                    <p class="text-xs text-slate-400 mt-1" id="analysis-date"></p>
                </div>
                <div class="card border-r-4 border-blue-500">
                    <div class="stat-lbl">דקות/ק"מ ביצוע</div>
                    <div class="stat-val text-blue-600" id="kpi-min-km">-</div>
                    <div class="compare-box" id="compare-min-km"></div>
                </div>
                <div class="card border-r-4 border-cyan-500">
                    <div class="stat-lbl">ק"מ תח"צ ביצוע</div>
                    <div class="stat-val text-cyan-600" id="kpi-pt-km">-</div>
                    <div class="compare-box" id="compare-pt-km"></div>
                </div>
                <div class="card border-r-4 border-green-500">
                    <div class="stat-lbl">% תח"צ ביצוע</div>
                    <div class="stat-val" id="kpi-pt-pct">-</div>
                    <div class="compare-box" id="compare-pt-pct"></div>
                </div>
                <div class="card border-r-4 border-red-500">
                    <div class="stat-lbl">נהגים מתחת 75%</div>
                    <div class="stat-val text-red-500" id="kpi-low-count">-</div>
                    <div class="stat-sub text-slate-400" id="kpi-low-sub"></div>
                </div>
                <div class="card border-r-4 border-purple-500">
                    <div class="stat-lbl">סה"כ נהגים</div>
                    <div class="stat-val text-slate-700" id="kpi-total-drivers">-</div>
                </div>
                <div class="mt-auto space-y-2">
                    <button onclick="exportExcel()" class="w-full bg-green-600 text-white py-2.5 rounded-lg text-sm font-bold hover:bg-green-700 flex items-center justify-center gap-2"><i class="fas fa-file-excel"></i> ייצוא Excel</button>
                    <button onclick="downloadHTML()" class="w-full bg-slate-700 text-white py-2.5 rounded-lg text-sm font-bold hover:bg-slate-800 flex items-center justify-center gap-2"><i class="fas fa-download"></i> שמור דוח HTML</button>
                    <button onclick="resetAnalysis()" class="w-full bg-slate-200 text-slate-700 py-2.5 rounded-lg text-sm font-bold hover:bg-slate-300 flex items-center justify-center gap-2"><i class="fas fa-redo"></i> ניתוח חדש</button>
                </div>
            </aside>
            <main class="main">
                <div class="mb-4 space-y-3">
                    <input type="text" id="search" onkeyup="filterTable()" placeholder="חיפוש..." class="w-full p-2.5 pr-4 border rounded-lg text-sm">
                    <div class="flex flex-wrap items-center gap-3 text-sm">
                        <label class="text-slate-600 font-bold">סינון ימים:</label>
                        <select id="day-filter" class="p-2 border rounded-lg text-sm" onchange="setDayFilter(this.value)">
                            <option value="all">כל הימים</option>
                            <option value="weekday">א-ה</option>
                            <option value="friday">שישי</option>
                            <option value="saturday">מוצ&quot;ש</option>
                        </select>
                        <span id="day-filter-hint" class="text-xs text-slate-500"></span>
                    </div>
                </div>
                <div class="tabs-nav">
                    <div class="tab-btn active" onclick="showTab('drivers', this)"><i class="fas fa-user"></i> נהגים <span class="badge" id="badge-drivers">0</span></div>
                    <div class="tab-btn" onclick="showTab('low', this)"><i class="fas fa-exclamation-triangle"></i> מתחת 75% <span class="badge" id="badge-low">0</span></div>
                    <div class="tab-btn" onclick="showTab('planning', this)"><i class="fas fa-clipboard-list"></i> תכנון <span class="badge" id="badge-planning">0</span></div>
                    <div class="tab-btn" onclick="showTab('gaps', this)"><i class="fas fa-chart-bar"></i> ניתוח פערים</div>
                </div>
                <div id="view-drivers" class="view">
                    <div class="table-wrap" style="max-height: calc(100vh - 280px); overflow-y: auto;">
                        <table class="data-table" id="table-drivers">
                            <thead>
                                <tr>
                                    <th>תאריך</th>
                                    <th>נהג</th>
                                    <th>סידור</th>
                                    <th>התחלה</th>
                                    <th>סיום</th>
                                    <th>דקות כולל</th>
                                    <th>דקות תח"צ</th>
                                    <th>ק"מ תח"צ</th>
                                    <th>דק/ק"מ</th>
                                    <th>% תח"צ</th>
                                    <th>סטטוס</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="drivers-pagination"></div>
                </div>
                <div id="view-low" class="view hidden">
                    <div class="table-wrap" style="max-height: calc(100vh - 280px); overflow-y: auto;">
                        <table class="data-table" id="table-low">
                            <thead>
                                <tr>
                                    <th>תאריך</th>
                                    <th>נהג</th>
                                    <th>התחלה</th>
                                    <th>סיום</th>
                                    <th>דקות כולל</th>
                                    <th>דקות תח"צ</th>
                                    <th>% תח"צ</th>
                                    <th>פער מ-75%</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="low-pagination"></div>
                </div>
                <div id="view-planning" class="view hidden">
                    <div class="table-wrap" style="max-height: calc(100vh - 280px); overflow-y: auto;">
                        <table class="data-table" id="table-planning">
                            <thead>
                                <tr>
                                    <th>סידור</th>
                                    <th>דקות כולל</th>
                                    <th>דקות תח"צ</th>
                                    <th>ק"מ תח"צ</th>
                                    <th>דק/ק"מ</th>
                                    <th>% תח"צ</th>
                                    <th>נסיעות</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="planning-pagination"></div>
                </div>
                <div id="view-gaps" class="view hidden"><div id="gaps-container"></div></div>
            </main>
        </div>
    </div>

    <div id="detail-modal" class="modal hidden" onclick="if(event.target===this)closeModal()">
        <div class="modal-content">
            <div class="modal-header"><h3 class="text-lg font-bold" id="modal-title">פירוט</h3><span class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></span></div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

<script>
const CATEGORY_COLORS = { 'תח"צ': '#22c55e', 'הכנת מכונה': '#f59e0b', 'נסיעה ריקה': '#ef4444', 'המתנה': '#8b5cf6', 'הפסקה': '#06b6d4', 'לרשות': '#ec4899', 'אחר': '#64748b' };
const MAX_TRIP_KM = 200;
const PAGE_SIZE = 50;

let STATE = {
    execFile: null,
    planFile: null,
    execData: null,
    planData: null,
    execResults: [],
    planResults: [],
    gaps: [],
    driverDetails: {},
    dutyDetails: {},
    hasExecKm: false,
    planPtKm: 0,
    isNegev: false,
    kmSource: 'none',
    mappings: null,
    pagination: {
        drivers: { page: 1 },
        low: { page: 1 },
        planning: { page: 1 }
    },
    dayCounts: { all: 0, weekday: 0, friday: 0, saturday: 0 },
    selectedDayFilter: 'all'
};

const DEFAULT_MAPPING = {
    exec: {
        date: ['תאריך ייחוס', 'תאריך', 'Date'],
        driver: ['קוד נהג', 'Driver', 'Driver Id'],
        dutyId: ['קוד סידור תכנון', 'Duty Id', 'Duty id'],
        start: ['שעת התחלה', 'Start Time', 'Start'],
        end: ['שעת סיום', 'End Time', 'End'],
        line: ['קו - מק"ט', 'Line', 'Line Id', 'Route Id'],
        desc: ['תאור', 'Description'],
        distance: ['מרחק', 'Distance', 'Trip Distance']
    },
    plan: {
        dutyId: ['Duty id', 'Duty Id'],
        eventType: ['Event Type', 'Event'],
        start: ['Start Time', 'Start'],
        end: ['End Time', 'End'],
        distance: ['Distance', 'Trip Distance'],
        routeId: ['Route Id', 'Route'],
        sign: ['Sign', 'Sign Id'],
        origin: ['Origin Stop Name', 'Origin'],
        destination: ['Destination Stop Name', 'Destination'],
        dayOffset: ['Day Offset', 'DayOffset']
    }
};

const MAPPING_LABELS = {
    exec: {
        date: 'תאריך',
        driver: 'נהג',
        dutyId: 'סידור תכנון',
        start: 'שעת התחלה',
        end: 'שעת סיום',
        line: 'מספר קו',
        desc: 'תיאור',
        distance: 'מרחק/ק"מ'
    },
    plan: {
        dutyId: 'סידור (Duty Id)',
        eventType: 'סוג אירוע',
        start: 'שעת התחלה',
        end: 'שעת סיום',
        distance: 'מרחק/ק"מ',
        routeId: 'Route',
        sign: 'Sign',
        origin: 'תחנת מוצא',
        destination: 'תחנת יעד',
        dayOffset: 'Day Offset'
    }
};

const escapeHtml = (value) => {
    const str = String(value ?? '');
    return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
};

const safeText = (value) => escapeHtml(value);

const parseDateValue = (value) => {
    if (!value) return null;
    if (value instanceof Date && !Number.isNaN(value.getTime())) return value;
    const str = String(value).trim();
    const direct = new Date(str);
    if (!Number.isNaN(direct.getTime())) return direct;
    const match = str.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})$/);
    if (!match) return null;
    const day = parseInt(match[1], 10);
    const month = parseInt(match[2], 10);
    let year = parseInt(match[3], 10);
    if (year < 100) year += 2000;
    const parsed = new Date(year, month - 1, day);
    return Number.isNaN(parsed.getTime()) ? null : parsed;
};

const getDayGroup = (dateValue) => {
    const date = parseDateValue(dateValue);
    if (!date) return 'unknown';
    const day = date.getDay();
    if (day >= 0 && day <= 4) return 'weekday';
    if (day === 5) return 'friday';
    return 'saturday';
};

const collectDayCounts = (execData) => {
    const uniqueDates = new Set();
    const groupSets = {
        weekday: new Set(),
        friday: new Set(),
        saturday: new Set()
    };
    execData.forEach((row) => {
        const dateValue = getMappedValue(row, 'exec', 'date');
        if (!dateValue) return;
        uniqueDates.add(dateValue);
        const group = getDayGroup(dateValue);
        if (group !== 'unknown') groupSets[group].add(dateValue);
    });
    return {
        all: uniqueDates.size,
        weekday: groupSets.weekday.size,
        friday: groupSets.friday.size,
        saturday: groupSets.saturday.size
    };
};

const getFilteredExecResults = () => {
    if (STATE.selectedDayFilter === 'all') return STATE.execResults;
    return STATE.execResults.filter((row) => row.dayGroup === STATE.selectedDayFilter);
};

const getPlanScale = () => {
    const count = STATE.dayCounts[STATE.selectedDayFilter] || 0;
    return Math.max(count, 0);
};

const updateDayFilterHint = () => {
    const hint = document.getElementById('day-filter-hint');
    if (!hint) return;
    const { all, weekday, friday, saturday } = STATE.dayCounts;
    hint.textContent = `א-ה: ${weekday} ימים | שישי: ${friday} ימים | מוצ"ש: ${saturday} ימים | סה"כ: ${all}`;
};

const setDayFilter = (value) => {
    STATE.selectedDayFilter = value;
    STATE.pagination.drivers.page = 1;
    STATE.pagination.low.page = 1;
    STATE.pagination.planning.page = 1;
    STATE.gaps = analyzeGaps();
    updateKPIs();
    renderTables();
    renderGapsDetailed();
};

const getHour = (t) => {
    if (!t) return null;
    const hour = parseInt(String(t).split(':')[0], 10);
    return Number.isNaN(hour) ? null : hour;
};

const parseTime = (t) => {
    if (!t) return null;
    const parts = String(t).trim().replace('.', ':').split(':');
    const hours = parseInt(parts[0], 10);
    const minutes = parseInt(parts[1], 10);
    if (Number.isNaN(hours) || Number.isNaN(minutes)) return null;
    return hours * 60 + minutes;
};

const formatMinutes = (m) => {
    if (m == null || Number.isNaN(m)) return '';
    const hours = Math.floor(m / 60);
    const minutes = m % 60;
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
};

const detectMidnightCrossing = (starts, ends) => {
    const hours = starts.concat(ends).map(getHour).filter((h) => h !== null);
    return hours.some((h) => h >= 22) && hours.some((h) => h < 6);
};

const parseDriverTimes = (starts, ends) => {
    const hasMidnight = detectMidnightCrossing(starts, ends);
    return starts.map((start, i) => {
        const end = ends[i];
        const startHour = getHour(start);
        const dayOffset = hasMidnight && startHour !== null && startHour < 6 ? 1 : 0;
        let startMin = parseTime(start);
        let endMin = parseTime(end);
        if (startMin !== null) startMin += dayOffset * 1440;
        if (endMin !== null) endMin += dayOffset * 1440;
        if (startMin !== null && endMin !== null && endMin < startMin && (endMin + 1440 - startMin) <= 720) endMin += 1440;
        return { startMin, endMin };
    });
};

const categorizeActivity = (desc, isPT) => {
    if (isPT) return 'תח"צ';
    const d = String(desc || '').toLowerCase();
    if (d.includes('הכנת מכונה')) return 'הכנת מכונה';
    if (d.includes('יציאה מחניון') || d.includes('חזרה לחניון') || d.includes('נסיעה ריקה')) return 'נסיעה ריקה';
    if (d.includes('הפסקה')) return 'הפסקה';
    if (d.includes('המתנה') || d.includes('standby')) return 'המתנה';
    if (d.includes('לרשות')) return 'לרשות';
    return 'אחר';
};

const isNegevCluster = (filename, data) => {
    const fn = (filename || '').toLowerCase();
    if (fn.includes('נגב') || fn.includes('negev')) return true;
    const negevStations = ['ב"ש', 'באר שבע', 'דימונה', 'ערד', 'ירוחם', 'מצפה רמון', 'אופקים', 'נתיבות', 'שדרות'];
    const sampleDescs = (data || []).slice(0, 100).map((row) => String(row.Description || row['תאור'] || '')).join(' ');
    return negevStations.some((s) => sampleDescs.includes(s));
};

const normalizeMapping = (data, type) => {
    if (!data || data.length === 0) return null;
    const columns = Object.keys(data[0]);
    const mapping = {};
    Object.entries(DEFAULT_MAPPING[type]).forEach(([key, candidates]) => {
        const match = candidates.find((candidate) => columns.includes(candidate));
        mapping[key] = match || '';
    });
    return { columns, mapping };
};

const buildMappingUI = () => {
    const mappingSection = document.getElementById('mapping-section');
    const grid = document.getElementById('mapping-grid');
    grid.innerHTML = '';
    const execMap = normalizeMapping(STATE.execData, 'exec');
    const planMap = STATE.planData ? normalizeMapping(STATE.planData, 'plan') : null;
    if (!execMap) return;

    const makeSelect = (label, key, columns, current, scope) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'flex flex-col gap-1';
        const labelEl = document.createElement('label');
        labelEl.className = 'text-xs text-slate-600 font-bold';
        labelEl.textContent = `${label}${scope === 'plan' ? ' (תכנון)' : ''}`;
        const select = document.createElement('select');
        select.className = 'p-2 border rounded-lg text-sm';
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = '—';
        select.appendChild(emptyOption);
        columns.forEach((col) => {
            const option = document.createElement('option');
            option.value = col;
            option.textContent = col;
            if (col === current) option.selected = true;
            select.appendChild(option);
        });
        select.addEventListener('change', () => {
            STATE.mappings[scope][key] = select.value;
            updateAnalyzeButton();
        });
        wrapper.appendChild(labelEl);
        wrapper.appendChild(select);
        return wrapper;
    };

    STATE.mappings = { exec: execMap.mapping, plan: planMap ? planMap.mapping : {} };

    Object.entries(MAPPING_LABELS.exec).forEach(([key, label]) => {
        grid.appendChild(makeSelect(label, key, execMap.columns, execMap.mapping[key], 'exec'));
    });

    if (planMap) {
        Object.entries(MAPPING_LABELS.plan).forEach(([key, label]) => {
            grid.appendChild(makeSelect(label, key, planMap.columns, planMap.mapping[key], 'plan'));
        });
    }

    mappingSection.classList.remove('hidden');
};

const getMappedValue = (row, scope, key) => {
    const column = STATE.mappings?.[scope]?.[key];
    if (!column) return '';
    return row[column];
};

const handleFile = (input, type) => {
    const file = input.files[0];
    if (!file) return;
    document.getElementById(`${type}-zone`).classList.add('has-file');
    document.getElementById(`${type}-filename`).textContent = file.name;
    Papa.parse(file, {
        header: true,
        encoding: 'UTF-8',
        complete: (result) => {
            const data = result.data.filter((row) => Object.values(row).some((value) => value));
            if (type === 'exec') {
                STATE.execFile = file;
                STATE.execData = data;
                STATE.isNegev = isNegevCluster(file.name, data);
            } else {
                STATE.planFile = file;
                STATE.planData = data;
                if (!STATE.isNegev) STATE.isNegev = isNegevCluster(file.name, data);
            }
            buildMappingUI();
            updateAnalyzeButton();
        }
    });
};

const updateAnalyzeButton = () => {
    const btn = document.getElementById('analyze-btn');
    const status = document.getElementById('status-indicator');
    if (!STATE.execData) {
        btn.disabled = true;
        status.innerHTML = '<i class="fas fa-circle-info ml-1"></i> טען קובץ ביצוע';
        return;
    }
    if (!STATE.mappings || !STATE.mappings.exec.date || !STATE.mappings.exec.driver || !STATE.mappings.exec.start || !STATE.mappings.exec.end) {
        btn.disabled = true;
        status.innerHTML = '<i class="fas fa-circle-info ml-1"></i> השלמת מיפוי עמודות';
        return;
    }
    btn.disabled = false;
    status.innerHTML = '<i class="fas fa-check-circle text-green-500 ml-1"></i> מוכן לניתוח';
};

const collectPlanKm = () => {
    if (!STATE.planData) return 0;
    return STATE.planData.filter((row) => getMappedValue(row, 'plan', 'eventType') === 'service_trip').reduce((sum, row) => {
        const km = parseFloat(getMappedValue(row, 'plan', 'distance')) || 0;
        if (!STATE.isNegev && km > MAX_TRIP_KM) return sum;
        return sum + km;
    }, 0);
};

const analyzeExecution = () => {
    const results = [];
    STATE.driverDetails = {};
    if (!STATE.execData || STATE.execData.length === 0) return results;

    STATE.hasExecKm = Boolean(STATE.mappings?.exec?.distance);

    const grouped = {};
    const execDateKey = 'date';
    const execDriverKey = 'driver';

    STATE.execData.forEach((row) => {
        const date = getMappedValue(row, 'exec', execDateKey) || '';
        const driver = getMappedValue(row, 'exec', execDriverKey);
        if (!driver) return;
        const key = `${date}|${driver}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(row);
    });

    STATE.dayCounts = collectDayCounts(STATE.execData);

    let totalExecPtTrips = 0;
    Object.values(grouped).forEach((rows) => {
        totalExecPtTrips += rows.filter((row) => getMappedValue(row, 'exec', 'line')).length;
    });

    const manualKm = parseFloat(document.getElementById('manual-km')?.value) || 0;
    STATE.planPtKm = collectPlanKm();
    const useKmSource = STATE.hasExecKm ? 'exec' : (manualKm > 0 ? 'manual' : (STATE.planPtKm > 0 ? 'plan' : 'none'));

    Object.entries(grouped).forEach(([key, rows]) => {
        const [date, driver] = key.split('|');
        const starts = rows.map((row) => getMappedValue(row, 'exec', 'start'));
        const ends = rows.map((row) => getMappedValue(row, 'exec', 'end'));
        const parsedTimes = parseDriverTimes(starts, ends);
        const activities = [];
        const breakdown = {};
        let ptMinutes = 0;
        let ptKm = 0;
        let tripCount = 0;

        const dutyIds = [...new Set(rows.map((row) => getMappedValue(row, 'exec', 'dutyId')).filter((duty) => duty && !Number.isNaN(Number(duty))))];

        rows.forEach((row, i) => {
            const isPT = Boolean(getMappedValue(row, 'exec', 'line'));
            const { startMin, endMin } = parsedTimes[i];
            const duration = startMin !== null && endMin !== null && endMin > startMin ? endMin - startMin : 0;
            const description = getMappedValue(row, 'exec', 'desc');
            const category = categorizeActivity(description, isPT);

            let km = 0;
            if (STATE.hasExecKm) {
                km = parseFloat(getMappedValue(row, 'exec', 'distance')) || 0;
                if (!STATE.isNegev && km > MAX_TRIP_KM) km = 0;
            }

            activities.push({
                startTime: getMappedValue(row, 'exec', 'start'),
                endTime: getMappedValue(row, 'exec', 'end'),
                startMin,
                endMin,
                duration,
                isPT,
                category,
                line: getMappedValue(row, 'exec', 'line') || '',
                description: description || '',
                km,
                dutyId: getMappedValue(row, 'exec', 'dutyId')
            });

            if (!breakdown[category]) breakdown[category] = { minutes: 0, km: 0 };
            breakdown[category].minutes += duration;
            breakdown[category].km += km;
            if (isPT) {
                ptMinutes += duration;
                ptKm += km;
                tripCount += 1;
            }
        });

        activities.sort((a, b) => (a.startMin || 0) - (b.startMin || 0));
        const allTimes = parsedTimes.flatMap((t) => [t.startMin, t.endMin]).filter((t) => t !== null);
        if (allTimes.length === 0) return;
        const workStart = Math.min(...allTimes);
        const workEnd = Math.max(...allTimes);
        const totalMinutes = workEnd - workStart;
        const machineMinutes = breakdown['הכנת מכונה']?.minutes || 0;
        const paymentMinutes = totalMinutes - machineMinutes;
        const nonPtMinutes = totalMinutes - ptMinutes;

        let effectivePtKm = ptKm;
        if (useKmSource === 'manual' && totalExecPtTrips > 0) {
            effectivePtKm = (manualKm / totalExecPtTrips) * tripCount;
        } else if (useKmSource === 'plan' && totalExecPtTrips > 0) {
            effectivePtKm = (STATE.planPtKm / totalExecPtTrips) * tripCount;
        }

        const minPerKm = effectivePtKm > 0 ? paymentMinutes / effectivePtKm : 0;
        const ptPercent = totalMinutes > 0 ? (ptMinutes / totalMinutes) * 100 : 0;
        const status = ptPercent >= 75 ? 'תקין' : ptPercent >= 65 ? 'נמוך' : 'חריג';

        let dutyStatus = '';
        if (dutyIds.length === 0) {
            dutyStatus = 'ללא סידור';
        } else if (dutyIds.length === 1) {
            dutyStatus = 'מלא';
            if (STATE.planData && STATE.mappings?.plan?.dutyId) {
                const planDuty = STATE.planData.filter((row) => {
                    const dutyId = parseInt(getMappedValue(row, 'plan', 'dutyId'), 10);
                    return dutyId === parseInt(dutyIds[0], 10) && getMappedValue(row, 'plan', 'eventType') === 'service_trip';
                });
                const execTrips = activities.filter((activity) => activity.isPT).length;
                if (planDuty.length > 0 && execTrips < planDuty.length) {
                    dutyStatus = `חלקי (${execTrips}/${planDuty.length})`;
                }
            }
        } else {
            dutyStatus = `${dutyIds.length} סידורים`;
        }

        STATE.driverDetails[key] = {
            activities,
            breakdown,
            summary: { totalMinutes, ptMinutes, nonPtMinutes, ptKm: effectivePtKm, paymentMinutes },
            dutyIds
        };

        results.push({
            date,
            driver: parseInt(driver, 10),
            dayGroup: getDayGroup(date),
            totalMinutes: Math.round(totalMinutes),
            paymentMinutes: Math.round(paymentMinutes),
            ptMinutes: Math.round(ptMinutes),
            nonPtMinutes: Math.round(nonPtMinutes),
            ptKm: Math.round(effectivePtKm * 100) / 100,
            minPerKm: Math.round(minPerKm * 100) / 100,
            ptPercent: Math.round(ptPercent * 10) / 10,
            status,
            tripCount,
            startTime: formatMinutes(workStart),
            endTime: formatMinutes(workEnd),
            breakdown,
            dutyIds,
            dutyStatus
        });
    });

    STATE.kmSource = useKmSource;
    return results;
};

const analyzePlanning = () => {
    if (!STATE.planData || !STATE.mappings?.plan?.dutyId) return [];
    const results = [];
    STATE.dutyDetails = {};
    const grouped = {};
    const paymentEvents = ['service_trip', 'deadhead', 'depot_pull_out', 'depot_pull_in', 'standby', 'split'];

    STATE.planData.forEach((row) => {
        const dutyId = getMappedValue(row, 'plan', 'dutyId');
        if (!dutyId) return;
        if (!grouped[dutyId]) grouped[dutyId] = [];
        grouped[dutyId].push(row);
    });

    Object.entries(grouped).forEach(([dutyId, rows]) => {
        const activities = [];
        const breakdown = {};
        const allTimes = [];
        let ptMinutes = 0;
        let ptKm = 0;
        let tripCount = 0;
        let paymentMinutes = 0;

        rows.forEach((row) => {
            const dayOff = parseInt(getMappedValue(row, 'plan', 'dayOffset'), 10) || 0;
            let startMin = parseTime(getMappedValue(row, 'plan', 'start'));
            let endMin = parseTime(getMappedValue(row, 'plan', 'end'));
            if (startMin !== null) startMin += dayOff * 1440;
            if (endMin !== null) endMin += dayOff * 1440;
            if (startMin !== null && endMin !== null && endMin < startMin && (endMin + 1440 - startMin) <= 720) endMin += 1440;
            if (startMin !== null) allTimes.push(startMin);
            if (endMin !== null) allTimes.push(endMin);

            const duration = startMin !== null && endMin !== null && endMin > startMin ? endMin - startMin : 0;
            const eventType = getMappedValue(row, 'plan', 'eventType') || '';
            const isPT = eventType === 'service_trip';
            let km = parseFloat(getMappedValue(row, 'plan', 'distance')) || 0;
            if (!STATE.isNegev && km > MAX_TRIP_KM) km = 0;

            let category = 'אחר';
            if (isPT) category = 'תח"צ';
            else if (['deadhead', 'depot_pull_out', 'depot_pull_in'].includes(eventType)) category = 'נסיעה ריקה';
            else if (eventType === 'standby') category = 'המתנה';
            else if (['sign_on', 'post_trip'].includes(eventType)) category = 'הכנת מכונה';
            else if (eventType === 'split') category = 'הפסקה';

            activities.push({
                startTime: getMappedValue(row, 'plan', 'start'),
                endTime: getMappedValue(row, 'plan', 'end'),
                startMin,
                endMin,
                duration,
                isPT,
                category,
                eventType,
                routeId: getMappedValue(row, 'plan', 'routeId') || '',
                km,
                sign: getMappedValue(row, 'plan', 'sign') || '',
                origin: getMappedValue(row, 'plan', 'origin') || '',
                destination: getMappedValue(row, 'plan', 'destination') || ''
            });

            if (!breakdown[category]) breakdown[category] = { minutes: 0, km: 0 };
            breakdown[category].minutes += duration;
            breakdown[category].km += km;
            if (isPT) {
                ptMinutes += duration;
                ptKm += km;
                tripCount += 1;
            }
            if (paymentEvents.includes(eventType)) paymentMinutes += duration;
        });

        if (allTimes.length === 0) return;
        activities.sort((a, b) => (a.startMin || 0) - (b.startMin || 0));
        const dutyStart = Math.min(...allTimes);
        const dutyEnd = Math.max(...allTimes);
        const totalMinutes = dutyEnd - dutyStart;
        const minPerKm = ptKm > 0 ? paymentMinutes / ptKm : 0;
        const ptPercent = totalMinutes > 0 ? (ptMinutes / totalMinutes) * 100 : 0;

        STATE.dutyDetails[dutyId] = { activities, breakdown, summary: { totalMinutes, ptMinutes, ptKm, paymentMinutes } };
        results.push({
            dutyId: parseInt(dutyId, 10),
            totalMinutes: Math.round(totalMinutes),
            paymentMinutes: Math.round(paymentMinutes),
            ptMinutes: Math.round(ptMinutes),
            ptKm: Math.round(ptKm * 100) / 100,
            minPerKm: Math.round(minPerKm * 100) / 100,
            ptPercent: Math.round(ptPercent * 10) / 10,
            tripCount,
            breakdown
        });
    });

    return results;
};

const analyzeGaps = () => {
    const totalBreakdown = {};
    let totalMinutes = 0;
    let totalPtMinutes = 0;
    let totalPtKm = 0;
    let totalPaymentMinutes = 0;

    const filteredExec = getFilteredExecResults();
    filteredExec.forEach((result) => {
        totalMinutes += result.totalMinutes;
        totalPtMinutes += result.ptMinutes;
        totalPtKm += result.ptKm;
        totalPaymentMinutes += result.paymentMinutes || result.totalMinutes;
        Object.entries(result.breakdown || {}).forEach(([cat, data]) => {
            if (!totalBreakdown[cat]) totalBreakdown[cat] = { minutes: 0, km: 0 };
            totalBreakdown[cat].minutes += data.minutes;
            totalBreakdown[cat].km += data.km;
        });
    });

    const execAvgMinKm = totalPtKm > 0 ? totalPaymentMinutes / totalPtKm : 0;

    let planAvgMinKm = 0;
    let planPaymentMin = 0;
    let planPtKm = 0;
    if (STATE.planResults.length > 0) {
        const planScale = getPlanScale();
        planPaymentMin = STATE.planResults.reduce((sum, row) => sum + (row.paymentMinutes ?? row.totalMinutes), 0) * planScale;
        planPtKm = STATE.planResults.reduce((sum, row) => sum + row.ptKm, 0) * planScale;
        planAvgMinKm = planPtKm > 0 ? planPaymentMin / planPtKm : 0;
    }

    return {
        summary: {
            execAvgMinKm,
            planAvgMinKm,
            gap: execAvgMinKm - planAvgMinKm,
            totalMinutes,
            totalPtMinutes,
            totalPtKm,
            nonPtMinutes: totalMinutes - totalPtMinutes,
            execPaymentMin: totalPaymentMinutes,
            planPaymentMin
        },
        breakdown: totalBreakdown,
        lowDrivers: filteredExec.filter((row) => row.ptPercent < 75)
    };
};

const runAnalysis = () => {
    STATE.execResults = analyzeExecution();
    STATE.planResults = analyzePlanning();
    STATE.gaps = analyzeGaps();
    updateDayFilterHint();

    updateKPIs();
    renderTables();
    renderGapsDetailed();

    document.getElementById('upload-section').classList.add('hidden');
    document.getElementById('results-section').classList.remove('hidden');
    document.getElementById('analysis-date').textContent = new Date().toLocaleDateString('he-IL') + ' ' + new Date().toLocaleTimeString('he-IL');
};

const updateKPIs = () => {
    const filteredExec = getFilteredExecResults();
    const totalPaymentMin = filteredExec.reduce((sum, row) => sum + (row.paymentMinutes || row.totalMinutes), 0);
    const totalPtKm = filteredExec.reduce((sum, row) => sum + row.ptKm, 0);
    const execAvgMinKm = totalPtKm > 0 ? totalPaymentMin / totalPtKm : 0;
    const execAvgPt = filteredExec.reduce((sum, row) => sum + row.ptPercent, 0) / (filteredExec.length || 1);
    const lowCount = filteredExec.filter((row) => row.ptPercent < 75).length;

    document.getElementById('kpi-min-km').textContent = execAvgMinKm.toFixed(2);
    document.getElementById('kpi-pt-km').textContent = totalPtKm.toLocaleString('he-IL');
    document.getElementById('kpi-pt-pct').textContent = `${execAvgPt.toFixed(1)}%`;
    document.getElementById('kpi-pt-pct').className = `stat-val ${execAvgPt >= 75 ? 'text-green-600' : 'text-red-500'}`;
    document.getElementById('kpi-low-count').textContent = lowCount;
    document.getElementById('kpi-low-sub').textContent = `מתוך ${filteredExec.length} נהגים`;
    document.getElementById('kpi-total-drivers').textContent = filteredExec.length;

    let kmSourceNote = '';
    if (STATE.kmSource === 'plan') kmSourceNote = '<div class="text-xs text-amber-600 mt-1"><i class="fas fa-info-circle"></i> ק"מ מתכנון</div>';
    else if (STATE.kmSource === 'manual') kmSourceNote = '<div class="text-xs text-amber-600 mt-1"><i class="fas fa-info-circle"></i> ק"מ ידני</div>';
    else if (STATE.kmSource === 'none') kmSourceNote = '<div class="text-xs text-red-500 mt-1"><i class="fas fa-exclamation-triangle"></i> אין נתוני ק"מ</div>';

    if (STATE.planResults.length > 0) {
        const planScale = getPlanScale();
        const planPaymentMin = STATE.planResults.reduce((sum, row) => sum + (row.paymentMinutes ?? row.totalMinutes), 0) * planScale;
        const planTotalPtKm = STATE.planResults.reduce((sum, row) => sum + row.ptKm, 0) * planScale;
        const planAvgMinKm = planTotalPtKm > 0 ? planPaymentMin / planTotalPtKm : 0;
        const planAvgPt = STATE.planResults.reduce((sum, row) => sum + row.ptPercent, 0) / (STATE.planResults.length || 1);
        document.getElementById('compare-min-km').innerHTML = `<div><div class="compare-label">תכנון</div><div class="compare-val">${planAvgMinKm.toFixed(2)}</div></div><div class="text-lg ${execAvgMinKm > planAvgMinKm ? 'text-red-500' : 'text-green-500'}">${execAvgMinKm > planAvgMinKm ? '↑' : '↓'} ${Math.abs(execAvgMinKm - planAvgMinKm).toFixed(2)}</div>${kmSourceNote}`;
        document.getElementById('compare-pt-km').innerHTML = `<div><div class="compare-label">תכנון</div><div class="compare-val">${planTotalPtKm.toLocaleString('he-IL')}</div></div>`;
        document.getElementById('compare-pt-pct').innerHTML = `<div><div class="compare-label">תכנון</div><div class="compare-val">${planAvgPt.toFixed(1)}%</div></div><div><div class="compare-label">יעד</div><div class="compare-val text-green-600">75%</div></div>`;
    } else {
        document.getElementById('compare-min-km').innerHTML = `<span class="text-slate-400 text-xs">אין תכנון</span>${kmSourceNote}`;
        document.getElementById('compare-pt-km').innerHTML = '';
        document.getElementById('compare-pt-pct').innerHTML = `<div><div class="compare-label">יעד</div><div class="compare-val text-green-600">75%</div></div>`;
    }

    document.getElementById('badge-drivers').textContent = filteredExec.length;
    document.getElementById('badge-low').textContent = lowCount;
    document.getElementById('badge-planning').textContent = STATE.planResults.length;

    const hasExecKm = STATE.hasExecKm;
    if (!hasExecKm) {
        document.getElementById('manual-km-section').classList.remove('hidden');
        if (STATE.planPtKm > 0) {
            document.getElementById('planning-km-hint').textContent = `ק"מ תח"צ מתכנון: ${STATE.planPtKm.toFixed(0)}`;
        }
    }
};

const paginate = (items, page) => {
    const start = (page - 1) * PAGE_SIZE;
    return items.slice(start, start + PAGE_SIZE);
};

const renderPagination = (type, totalItems) => {
    const container = document.getElementById(`${type}-pagination`);
    const totalPages = Math.max(1, Math.ceil(totalItems / PAGE_SIZE));
    const current = STATE.pagination[type].page;
    container.innerHTML = '';

    const prevBtn = document.createElement('button');
    prevBtn.textContent = 'הקודם';
    prevBtn.disabled = current <= 1;
    prevBtn.addEventListener('click', () => {
        STATE.pagination[type].page -= 1;
        renderTables();
    });

    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'הבא';
    nextBtn.disabled = current >= totalPages;
    nextBtn.addEventListener('click', () => {
        STATE.pagination[type].page += 1;
        renderTables();
    });

    const label = document.createElement('span');
    label.textContent = `עמוד ${current} מתוך ${totalPages}`;
    label.className = 'text-xs text-slate-500';

    container.appendChild(prevBtn);
    container.appendChild(label);
    container.appendChild(nextBtn);
};

const renderTables = () => {
    const driversTable = document.querySelector('#table-drivers tbody');
    const lowTable = document.querySelector('#table-low tbody');
    const planningTable = document.querySelector('#table-planning tbody');

    const filteredExec = getFilteredExecResults();
    const driversPage = paginate(filteredExec, STATE.pagination.drivers.page);
    const lowDrivers = filteredExec.filter((row) => row.ptPercent < 75);
    const lowPage = paginate(lowDrivers, STATE.pagination.low.page);
    const planningPage = paginate(STATE.planResults, STATE.pagination.planning.page);

    const buildRow = (cells) => {
        const row = document.createElement('tr');
        cells.forEach((cell) => row.appendChild(cell));
        return row;
    };

    const makeCell = (content, className, isHtml) => {
        const td = document.createElement('td');
        if (className) td.className = className;
        if (isHtml) {
            td.innerHTML = content;
        } else {
            td.textContent = content;
        }
        return td;
    };

    driversTable.innerHTML = '';
    driversPage.forEach((row) => {
        const dutyCell = document.createElement('td');
        if (row.dutyIds && row.dutyIds.length > 0) {
            const wrapper = document.createElement('div');
            row.dutyIds.forEach((dutyId, idx) => {
                const dutyLink = document.createElement('span');
                dutyLink.className = 'clickable text-blue-600';
                dutyLink.textContent = parseInt(dutyId, 10);
                dutyLink.addEventListener('click', () => showDutyDetail(parseInt(dutyId, 10)));
                wrapper.appendChild(dutyLink);
                if (idx < row.dutyIds.length - 1) wrapper.appendChild(document.createTextNode(', '));
            });
            const status = document.createElement('div');
            status.className = `text-xs ${row.dutyStatus === 'מלא' ? 'text-green-600' : row.dutyStatus.includes('חלקי') ? 'text-amber-600' : row.dutyIds.length > 1 ? 'text-purple-600' : ''}`;
            status.textContent = row.dutyStatus;
            dutyCell.appendChild(wrapper);
            dutyCell.appendChild(status);
        } else {
            dutyCell.textContent = '-';
            dutyCell.className = 'text-slate-400';
        }

        const driverCell = document.createElement('td');
        driverCell.className = 'font-bold clickable';
        driverCell.textContent = row.driver;
        driverCell.addEventListener('click', () => showDriverDetail(row.date, row.driver));

        driversTable.appendChild(buildRow([
            makeCell(row.date),
            driverCell,
            dutyCell,
            makeCell(row.startTime, 'font-mono text-xs'),
            makeCell(row.endTime, 'font-mono text-xs'),
            makeCell(row.totalMinutes),
            makeCell(row.ptMinutes),
            makeCell(row.ptKm),
            makeCell(row.minPerKm, 'font-bold'),
            makeCell(`${row.ptPercent}%`, `font-bold ${row.ptPercent >= 75 ? 'text-green-600' : 'text-red-500'}`),
            makeCell(`<span class="${row.status === 'תקין' ? 'status-ok' : row.status === 'נמוך' ? 'status-warn' : 'status-bad'}">${safeText(row.status)}</span>`, '', true)
        ]));
    });

    lowTable.innerHTML = '';
    lowPage.forEach((row) => {
        const driverCell = document.createElement('td');
        driverCell.className = 'font-bold clickable';
        driverCell.textContent = row.driver;
        driverCell.addEventListener('click', () => showDriverDetail(row.date, row.driver));
        lowTable.appendChild(buildRow([
            makeCell(row.date),
            driverCell,
            makeCell(row.startTime, 'font-mono text-xs'),
            makeCell(row.endTime, 'font-mono text-xs'),
            makeCell(row.totalMinutes),
            makeCell(row.ptMinutes),
            makeCell(`${row.ptPercent}%`, 'font-bold text-red-500'),
            makeCell(`-${(75 - row.ptPercent).toFixed(1)}%`, 'font-bold text-red-600')
        ]));
    });

    planningTable.innerHTML = '';
    planningPage.forEach((row) => {
        const dutyCell = document.createElement('td');
        dutyCell.className = 'font-bold clickable';
        dutyCell.textContent = row.dutyId;
        dutyCell.addEventListener('click', () => showDutyDetail(row.dutyId));
        planningTable.appendChild(buildRow([
            dutyCell,
            makeCell(row.totalMinutes),
            makeCell(row.ptMinutes),
            makeCell(row.ptKm),
            makeCell(row.minPerKm, 'font-bold'),
            makeCell(`${row.ptPercent}%`),
            makeCell(row.tripCount)
        ]));
    });

    renderPagination('drivers', filteredExec.length);
    renderPagination('low', lowDrivers.length);
    renderPagination('planning', STATE.planResults.length);
};

const renderGapsDetailed = () => {
    const gaps = STATE.gaps;
    const container = document.getElementById('gaps-container');
    if (!gaps || !gaps.summary) {
        container.innerHTML = '<div class="text-sm text-slate-500">אין נתונים להצגה.</div>';
        return;
    }

    const planBreakdown = {};
    let planTotalMin = 0;
    let planTotalKm = 0;
    const planScale = getPlanScale();
    STATE.planResults.forEach((row) => {
        Object.entries(row.breakdown || {}).forEach(([cat, data]) => {
            if (!planBreakdown[cat]) planBreakdown[cat] = { minutes: 0, km: 0 };
            planBreakdown[cat].minutes += data.minutes * planScale;
            planBreakdown[cat].km += data.km * planScale;
        });
        planTotalMin += row.totalMinutes * planScale;
    });
    Object.values(planBreakdown).forEach((data) => { planTotalKm += data.km; });

    const allCats = [...new Set([...Object.keys(gaps.breakdown), ...Object.keys(planBreakdown)])];

    const catDesc = {
        'תח"צ': 'נסיעות תחבורה ציבורית עם נוסעים (service_trip)',
        'נסיעה ריקה': 'יציאה מחניון, חזרה לחניון, נסיעות ריקות בין קווים',
        'הכנת מכונה': 'בדיקת רכב, sign_on, post_trip',
        'המתנה': 'זמן המתנה בין נסיעות (standby)',
        'הפסקה': 'הפסקות נהג (split)',
        'לרשות': 'זמן לרשות סדרן',
        'אחר': 'תדלוק, פעולות אחרות'
    };

    const barHtml = Object.entries(gaps.breakdown)
        .sort((a, b) => b[1].minutes - a[1].minutes)
        .map(([cat, data]) => {
            const pct = gaps.summary.totalMinutes > 0 ? (data.minutes / gaps.summary.totalMinutes) * 100 : 0;
            const color = CATEGORY_COLORS[cat] || '#64748b';
            return `<div class="breakdown-segment" style="width:${pct.toFixed(1)}%; background:${color}" title="${safeText(cat)}: ${Math.round(data.minutes)} דק">${pct > 5 ? `${pct.toFixed(1)}%` : ''}</div>`;
        })
        .join('');

    container.innerHTML = `
        <div class="gap-card">
            <div class="gap-title"><i class="fas fa-chart-pie ml-2 text-blue-500"></i> סיכום דקות/ק"מ</div>
            <div class="gap-breakdown">
                <div class="gap-item"><div class="gap-item-value text-blue-600">${gaps.summary.execAvgMinKm.toFixed(2)}</div><div class="gap-item-label">דק/ק"מ ביצוע</div></div>
                ${STATE.planResults.length > 0 ? `<div class="gap-item"><div class="gap-item-value text-slate-600">${gaps.summary.planAvgMinKm.toFixed(2)}</div><div class="gap-item-label">דק/ק"מ תכנון</div></div><div class="gap-item"><div class="gap-item-value ${gaps.summary.gap > 0 ? 'text-red-500' : 'text-green-500'}">${gaps.summary.gap > 0 ? '+' : ''}${gaps.summary.gap.toFixed(2)}</div><div class="gap-item-label">פער</div></div>` : ''}
            </div>
        </div>
        ${STATE.planResults.length > 0 ? `
        <div class="gap-card">
            <div class="gap-title"><i class="fas fa-balance-scale ml-2 text-indigo-500"></i> השוואת תכנון מול ביצוע לפי קטגוריה</div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm border-collapse">
                    <thead>
                        <tr class="bg-slate-100">
                            <th class="p-3 text-right font-bold border-b-2">קטגוריה</th>
                            <th colspan="3" class="p-3 text-center font-bold border-b-2 bg-blue-50">תכנון</th>
                            <th colspan="3" class="p-3 text-center font-bold border-b-2 bg-green-50">ביצוע</th>
                            <th colspan="3" class="p-3 text-center font-bold border-b-2 bg-amber-50">פער (ביצוע - תכנון)</th>
                        </tr>
                        <tr class="bg-slate-50 text-xs">
                            <th class="p-2 text-right border-b"></th>
                            <th class="p-2 text-center border-b bg-blue-50">דקות</th>
                            <th class="p-2 text-center border-b bg-blue-50">ק"מ</th>
                            <th class="p-2 text-center border-b bg-blue-50">%</th>
                            <th class="p-2 text-center border-b bg-green-50">דקות</th>
                            <th class="p-2 text-center border-b bg-green-50">ק"מ</th>
                            <th class="p-2 text-center border-b bg-green-50">%</th>
                            <th class="p-2 text-center border-b bg-amber-50">דקות</th>
                            <th class="p-2 text-center border-b bg-amber-50">ק"מ</th>
                            <th class="p-2 text-center border-b bg-amber-50">%</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allCats.sort((a, b) => {
                            const order = ['תח"צ', 'נסיעה ריקה', 'הכנת מכונה', 'המתנה', 'הפסקה', 'לרשות', 'אחר'];
                            return order.indexOf(a) - order.indexOf(b);
                        }).map((cat) => {
                            const plan = planBreakdown[cat] || { minutes: 0, km: 0 };
                            const exec = gaps.breakdown[cat] || { minutes: 0, km: 0 };
                            const planPct = planTotalMin > 0 ? (plan.minutes / planTotalMin) * 100 : 0;
                            const execPct = gaps.summary.totalMinutes > 0 ? (exec.minutes / gaps.summary.totalMinutes) * 100 : 0;
                            const diffMin = exec.minutes - plan.minutes;
                            const diffKm = exec.km - plan.km;
                            const diffPct = execPct - planPct;
                            const color = CATEGORY_COLORS[cat] || '#64748b';
                            return `
                            <tr class="border-b hover:bg-slate-50">
                                <td class="p-3 font-bold" style="border-right: 4px solid ${color}">
                                    ${safeText(cat)}
                                    <div class="text-xs text-slate-400 font-normal">${safeText(catDesc[cat] || '')}</div>
                                </td>
                                <td class="p-2 text-center bg-blue-50/30">${Math.round(plan.minutes).toLocaleString()}</td>
                                <td class="p-2 text-center bg-blue-50/30">${plan.km.toFixed(1)}</td>
                                <td class="p-2 text-center bg-blue-50/30 font-bold">${planPct.toFixed(1)}%</td>
                                <td class="p-2 text-center bg-green-50/30">${Math.round(exec.minutes).toLocaleString()}</td>
                                <td class="p-2 text-center bg-green-50/30">${exec.km.toFixed(1)}</td>
                                <td class="p-2 text-center bg-green-50/30 font-bold">${execPct.toFixed(1)}%</td>
                                <td class="p-2 text-center bg-amber-50/30 font-bold ${diffMin > 0 ? 'text-red-600' : diffMin < 0 ? 'text-green-600' : ''}">${diffMin > 0 ? '+' : ''}${Math.round(diffMin).toLocaleString()}</td>
                                <td class="p-2 text-center bg-amber-50/30 ${diffKm > 0 ? 'text-red-600' : diffKm < 0 ? 'text-green-600' : ''}">${diffKm > 0 ? '+' : ''}${diffKm.toFixed(1)}</td>
                                <td class="p-2 text-center bg-amber-50/30 font-bold ${diffPct > 0 ? 'text-red-600' : diffPct < 0 ? 'text-green-600' : ''}">${diffPct > 0 ? '+' : ''}${diffPct.toFixed(1)}%</td>
                            </tr>`;
                        }).join('')}
                        <tr class="bg-slate-200 font-bold">
                            <td class="p-3">סה"כ</td>
                            <td class="p-2 text-center">${Math.round(planTotalMin).toLocaleString()}</td>
                            <td class="p-2 text-center">${planTotalKm.toFixed(1)}</td>
                            <td class="p-2 text-center">100%</td>
                            <td class="p-2 text-center">${Math.round(gaps.summary.totalMinutes).toLocaleString()}</td>
                            <td class="p-2 text-center">${Object.values(gaps.breakdown).reduce((sum, data) => sum + data.km, 0).toFixed(1)}</td>
                            <td class="p-2 text-center">100%</td>
                            <td class="p-2 text-center ${gaps.summary.totalMinutes - planTotalMin > 0 ? 'text-red-600' : 'text-green-600'}">${gaps.summary.totalMinutes - planTotalMin > 0 ? '+' : ''}${Math.round(gaps.summary.totalMinutes - planTotalMin).toLocaleString()}</td>
                            <td class="p-2 text-center">-</td>
                            <td class="p-2 text-center">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 p-3 bg-indigo-50 rounded-lg text-sm text-indigo-700">
                <i class="fas fa-info-circle ml-1"></i> <strong>הסבר הקטגוריות:</strong><br>
                <span class="text-xs">
                • <strong>תח"צ</strong> - נסיעות שירות עם נוסעים<br>
                • <strong>נסיעה ריקה</strong> - יציאה/חזרה מחניון, מעברים בין קווים<br>
                • <strong>הכנת מכונה</strong> - בדיקות רכב בתחילת/סוף משמרת<br>
                • <strong>המתנה</strong> - זמן המתנה מתוכנן בין נסיעות<br>
                • <strong>הפסקה</strong> - הפסקות נהג<br>
                • <strong>לרשות</strong> - זמן לרשות סדרן (ביצוע בלבד)<br>
                • <strong>אחר</strong> - תדלוק, פעולות שונות
                </span>
            </div>
        </div>
        ` : ''}
        <div class="gap-card">
            <div class="gap-title"><i class="fas fa-clock ml-2 text-purple-500"></i> פילוח זמן ביצוע</div>
            <div class="mb-4"><div class="breakdown-bar">${barHtml}</div></div>
            <div class="gap-breakdown">
                ${Object.entries(gaps.breakdown).sort((a, b) => b[1].minutes - a[1].minutes).map(([cat, data]) => {
                    const pct = gaps.summary.totalMinutes > 0 ? (data.minutes / gaps.summary.totalMinutes) * 100 : 0;
                    const color = CATEGORY_COLORS[cat] || '#64748b';
                    const hours = (data.minutes / 60).toFixed(1);
                    return `<div class="gap-item" style="border-right: 4px solid ${color}"><div class="gap-item-value" style="color:${color}">${Math.round(data.minutes)}</div><div class="gap-item-label">${safeText(cat)}</div><div class="text-xs text-slate-500">${hours} שעות (${pct.toFixed(1)}%)</div></div>`;
                }).join('')}
            </div>
        </div>
        <div class="gap-card">
            <div class="gap-title"><i class="fas fa-exclamation-triangle ml-2 text-amber-500"></i> השפעה על דקות/ק"מ לפי קטגוריה</div>
            <div class="space-y-3">
                ${Object.entries(gaps.breakdown).filter(([cat]) => cat !== 'תח"צ').sort((a, b) => b[1].minutes - a[1].minutes).map(([cat, data]) => {
                    const color = CATEGORY_COLORS[cat] || '#64748b';
                    const impact = gaps.summary.totalPtKm > 0 ? data.minutes / gaps.summary.totalPtKm : 0;
                    const pctNonPt = gaps.summary.nonPtMinutes > 0 ? (data.minutes / gaps.summary.nonPtMinutes) * 100 : 0;
                    return `<div class="flex items-center gap-4 p-3 bg-slate-50 rounded-lg"><div class="w-3 h-3 rounded-full" style="background:${color}"></div><div class="flex-1"><div class="font-bold text-slate-700">${safeText(cat)}</div><div class="text-xs text-slate-500">${Math.round(data.minutes)} דקות (${pctNonPt.toFixed(1)}% מזמן לא-תח"צ)</div></div><div class="text-left"><div class="font-bold text-lg" style="color:${color}">+${impact.toFixed(2)}</div><div class="text-xs text-slate-500">דק/ק"מ</div></div></div>`;
                }).join('')}
            </div>
            <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-700"><i class="fas fa-lightbulb ml-1"></i> <strong>הסבר:</strong> כל קטגוריה מוסיפה לדקות/ק"מ את הזמן שלה חלקי סה"כ ק"מ תח"צ (${gaps.summary.totalPtKm.toFixed(0)} ק"מ).</div>
        </div>
        <div class="gap-card">
            <div class="gap-title"><i class="fas fa-users ml-2 text-red-500"></i> נהגים מתחת 75% תח"צ</div>
            <div class="gap-breakdown">
                <div class="gap-item"><div class="gap-item-value text-red-500">${gaps.lowDrivers.length}</div><div class="gap-item-label">נהגים</div></div>
                <div class="gap-item"><div class="gap-item-value text-slate-600">${gaps.lowDrivers.length > 0 ? (gaps.lowDrivers.reduce((sum, row) => sum + row.ptPercent, 0) / gaps.lowDrivers.length).toFixed(1) : 0}%</div><div class="gap-item-label">ממוצע % תח"צ</div></div>
                <div class="gap-item"><div class="gap-item-value text-amber-500">${gaps.lowDrivers.length > 0 ? (gaps.lowDrivers.reduce((sum, row) => sum + row.minPerKm, 0) / gaps.lowDrivers.length).toFixed(2) : 0}</div><div class="gap-item-label">ממוצע דק/ק"מ</div></div>
            </div>
        </div>
    `;
};

const showDriverDetail = (date, driver) => {
    const detail = STATE.driverDetails[`${date}|${driver}`];
    if (!detail) return;
    document.getElementById('modal-title').innerHTML = `<i class="fas fa-user ml-2"></i> נהג ${safeText(driver)} - ${safeText(date)}`;

    const barHtml = Object.entries(detail.breakdown)
        .sort((a, b) => b[1].minutes - a[1].minutes)
        .map(([cat, data]) => {
            const pct = detail.summary.totalMinutes > 0 ? (data.minutes / detail.summary.totalMinutes) * 100 : 0;
            const color = CATEGORY_COLORS[cat] || '#64748b';
            return `<div class="breakdown-segment" style="width:${pct.toFixed(1)}%; background:${color}" title="${safeText(cat)}: ${Math.round(data.minutes)} דק">${pct > 8 ? safeText(cat) : ''}</div>`;
        }).join('');

    const activitiesHtml = detail.activities.map((activity) => {
        const dutyId = activity.dutyId && !Number.isNaN(Number(activity.dutyId)) ? parseInt(activity.dutyId, 10) : null;
        const dutyCell = dutyId ? `<span class="clickable text-blue-600 text-xs" onclick="showDutyDetail(${dutyId})">${dutyId}</span>` : '<span class="text-slate-300">-</span>';
        return `<div class="activity-row with-duty ${activity.isPT ? 'activity-pt' : 'activity-non-pt'}"><div class="font-mono text-xs">${safeText(activity.startTime)} - ${safeText(activity.endTime)}</div><div><span class="inline-block w-2 h-2 rounded mr-1" style="background:${CATEGORY_COLORS[activity.category] || '#64748b'}"></span>${activity.isPT ? `<strong>קו ${safeText(parseInt(activity.line, 10) || activity.line)}</strong> - ` : ''}${safeText(activity.description || activity.category)}</div><div class="font-bold">${activity.duration} דק</div><div>${activity.km > 0 ? activity.km.toFixed(1) : '-'}</div><div>${dutyCell}</div></div>`;
    }).join('');

    document.getElementById('modal-body').innerHTML = `
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg text-center"><div class="text-2xl font-bold text-blue-600">${detail.summary.totalMinutes}</div><div class="text-xs text-slate-500">דקות כולל</div></div>
            <div class="bg-green-50 p-4 rounded-lg text-center"><div class="text-2xl font-bold text-green-600">${detail.summary.ptMinutes}</div><div class="text-xs text-slate-500">דקות תח"צ</div></div>
            <div class="bg-amber-50 p-4 rounded-lg text-center"><div class="text-2xl font-bold text-amber-600">${detail.summary.nonPtMinutes}</div><div class="text-xs text-slate-500">דקות לא-תח"צ</div></div>
            <div class="bg-purple-50 p-4 rounded-lg text-center"><div class="text-2xl font-bold text-purple-600">${detail.summary.ptKm.toFixed(1)}</div><div class="text-xs text-slate-500">ק"מ תח"צ</div></div>
        </div>
        <div class="mb-6"><div class="text-sm font-bold text-slate-700 mb-2">פילוח זמן</div><div class="breakdown-bar">${barHtml}</div>
        <div class="flex flex-wrap gap-3 mt-2">${Object.entries(detail.breakdown).sort((a, b) => b[1].minutes - a[1].minutes).map(([cat, data]) => `<div class="flex items-center gap-1 text-xs"><div class="w-3 h-3 rounded" style="background:${CATEGORY_COLORS[cat] || '#64748b'}"></div><span>${safeText(cat)}: ${Math.round(data.minutes)} דק (${detail.summary.totalMinutes > 0 ? (data.minutes / detail.summary.totalMinutes * 100).toFixed(1) : 0}%)</span></div>`).join('')}</div></div>
        <div class="text-sm font-bold text-slate-700 mb-2">פירוט פעילויות</div>
        <div class="border rounded-lg overflow-hidden"><div class="activity-row with-duty bg-slate-100 font-bold text-xs"><div>שעה</div><div>תיאור</div><div>משך</div><div>ק"מ</div><div>סידור</div></div>
        <div style="max-height: 400px; overflow-y: auto;">${activitiesHtml}</div></div>`;

    document.getElementById('detail-modal').classList.remove('hidden');
};

const showDutyDetail = (dutyId) => {
    const detail = STATE.dutyDetails[dutyId];
    if (!detail) {
        document.getElementById('modal-title').innerHTML = `<i class="fas fa-clipboard-list ml-2"></i> סידור ${safeText(dutyId)}`;
        document.getElementById('modal-body').innerHTML = `<div class="text-center py-8 text-slate-500"><i class="fas fa-info-circle text-4xl mb-4"></i><p>סידור ${safeText(dutyId)} לא נמצא בקובץ התכנון</p></div>`;
        document.getElementById('detail-modal').classList.remove('hidden');
        return;
    }

    document.getElementById('modal-title').innerHTML = `<i class="fas fa-clipboard-list ml-2"></i> סידור ${safeText(dutyId)}`;

    const barHtml = Object.entries(detail.breakdown)
        .sort((a, b) => b[1].minutes - a[1].minutes)
        .map(([cat, data]) => {
            const pct = detail.summary.totalMinutes > 0 ? (data.minutes / detail.summary.totalMinutes) * 100 : 0;
            const color = CATEGORY_COLORS[cat] || '#64748b';
            return `<div class="breakdown-segment" style="width:${pct.toFixed(1)}%; background:${color}" title="${safeText(cat)}: ${Math.round(data.minutes)} דק">${pct > 8 ? safeText(cat) : ''}</div>`;
        }).join('');

    const activitiesHtml = detail.activities.map((activity) => {
        let description = '';
        if (activity.isPT) {
            const lineNum = activity.sign || (activity.routeId ? activity.routeId.split('-')[0] : '');
            description = `<strong>קו ${safeText(lineNum)}</strong>`;
            if (activity.origin && activity.destination) {
                description += `<br><span class="text-xs text-slate-500">${safeText(activity.origin)} → ${safeText(activity.destination)}</span>`;
            }
        } else if (['deadhead', 'depot_pull_out', 'depot_pull_in'].includes(activity.eventType)) {
            const typeLabel = activity.eventType === 'depot_pull_out' ? 'יציאה מחניון' : activity.eventType === 'depot_pull_in' ? 'חזרה לחניון' : 'נסיעה ריקה';
            description = `<strong>${safeText(typeLabel)}</strong>`;
            if (activity.origin && activity.destination && activity.origin !== activity.destination) {
                description += `<br><span class="text-xs text-slate-500">${safeText(activity.origin)} → ${safeText(activity.destination)}</span>`;
            }
        } else {
            const labels = { sign_on: 'הכנת מכונה', post_trip: 'סיום', standby: 'המתנה', split: 'הפסקה' };
            description = `<strong>${safeText(labels[activity.eventType] || activity.eventType)}</strong>`;
            if (activity.origin) description += `<br><span class="text-xs text-slate-500">${safeText(activity.origin)}</span>`;
        }
        return `<div class="activity-row ${activity.isPT ? 'activity-pt' : 'activity-non-pt'}"><div class="font-mono text-xs">${safeText(activity.startTime)} - ${safeText(activity.endTime)}</div><div><span class="inline-block w-2 h-2 rounded mr-1" style="background:${CATEGORY_COLORS[activity.category] || '#64748b'}"></span>${description}</div><div class="font-bold">${activity.duration} דק</div><div>${activity.km > 0 ? activity.km.toFixed(1) : '-'}</div></div>`;
    }).join('');

    document.getElementById('modal-body').innerHTML = `
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg text-center"><div class="text-2xl font-bold text-blue-600">${detail.summary.totalMinutes}</div><div class="text-xs text-slate-500">דקות כולל</div></div>
            <div class="bg-green-50 p-4 rounded-lg text-center"><div class="text-2xl font-bold text-green-600">${detail.summary.ptMinutes}</div><div class="text-xs text-slate-500">דקות תח"צ</div></div>
            <div class="bg-purple-50 p-4 rounded-lg text-center"><div class="text-2xl font-bold text-purple-600">${detail.summary.ptKm.toFixed(1)}</div><div class="text-xs text-slate-500">ק"מ תח"צ</div></div>
        </div>
        <div class="mb-6"><div class="text-sm font-bold text-slate-700 mb-2">פילוח זמן</div><div class="breakdown-bar">${barHtml}</div>
        <div class="flex flex-wrap gap-3 mt-2">${Object.entries(detail.breakdown).sort((a, b) => b[1].minutes - a[1].minutes).map(([cat, data]) => `<div class="flex items-center gap-1 text-xs"><div class="w-3 h-3 rounded" style="background:${CATEGORY_COLORS[cat] || '#64748b'}"></div><span>${safeText(cat)}: ${Math.round(data.minutes)} דק (${detail.summary.totalMinutes > 0 ? (data.minutes / detail.summary.totalMinutes * 100).toFixed(1) : 0}%)</span></div>`).join('')}</div></div>
        <div class="text-sm font-bold text-slate-700 mb-2">פירוט אירועים</div>
        <div class="border rounded-lg overflow-hidden"><div class="activity-row bg-slate-100 font-bold text-xs"><div>שעה</div><div>תיאור</div><div>משך</div><div>ק"מ</div></div>
        ${activitiesHtml}</div>`;

    document.getElementById('detail-modal').classList.remove('hidden');
};

const closeModal = () => { document.getElementById('detail-modal').classList.add('hidden'); };

const showTab = (id, btn) => {
    document.querySelectorAll('.view').forEach((view) => view.classList.add('hidden'));
    document.getElementById(`view-${id}`).classList.remove('hidden');
    document.querySelectorAll('.tab-btn').forEach((button) => button.classList.remove('active'));
    btn.classList.add('active');
};

const filterTable = () => {
    const value = document.getElementById('search').value.toLowerCase();
    document.querySelectorAll('tbody tr').forEach((row) => {
        row.style.display = row.innerText.toLowerCase().includes(value) ? '' : 'none';
    });
};

const resetAnalysis = () => {
    STATE = {
        execFile: null,
        planFile: null,
        execData: null,
        planData: null,
        execResults: [],
        planResults: [],
        gaps: [],
        driverDetails: {},
        dutyDetails: {},
        hasExecKm: false,
        planPtKm: 0,
        isNegev: false,
        kmSource: 'none',
        mappings: null,
        pagination: {
            drivers: { page: 1 },
            low: { page: 1 },
            planning: { page: 1 }
        },
        dayCounts: { all: 0, weekday: 0, friday: 0, saturday: 0 },
        selectedDayFilter: 'all'
    };

    ['exec', 'plan'].forEach((type) => {
        document.getElementById(`${type}-zone`).classList.remove('has-file');
        document.getElementById(`${type}-filename`).textContent = '';
        document.getElementById(`${type}-file`).value = '';
    });

    document.getElementById('results-section').classList.add('hidden');
    document.getElementById('upload-section').classList.remove('hidden');
    document.getElementById('manual-km-section').classList.add('hidden');
    document.getElementById('mapping-section').classList.add('hidden');
    const manualKmInput = document.getElementById('manual-km');
    if (manualKmInput) manualKmInput.value = '';
    const dayFilter = document.getElementById('day-filter');
    if (dayFilter) dayFilter.value = 'all';
    updateDayFilterHint();
    updateAnalyzeButton();
};

const exportExcel = () => {
    const wb = XLSX.utils.book_new();
    const gaps = analyzeGaps();
    const filteredExec = getFilteredExecResults();
    const planScale = getPlanScale();

    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([
        { 'מדד': 'דק/ק"מ ביצוע', 'ערך': gaps.summary.execAvgMinKm.toFixed(2) },
        { 'מדד': 'דק/ק"מ תכנון', 'ערך': gaps.summary.planAvgMinKm.toFixed(2) },
        { 'מדד': 'פער', 'ערך': gaps.summary.gap.toFixed(2) },
        { 'מדד': 'נהגים מתחת 75%', 'ערך': gaps.lowDrivers.length }
    ]), 'סיכום');

    if (STATE.planResults.length > 0) {
        const planBreakdown = {};
        let planTotalMin = 0;
        STATE.planResults.forEach((row) => {
            Object.entries(row.breakdown || {}).forEach(([cat, data]) => {
                if (!planBreakdown[cat]) planBreakdown[cat] = { minutes: 0, km: 0 };
                planBreakdown[cat].minutes += data.minutes * planScale;
                planBreakdown[cat].km += data.km * planScale;
            });
            planTotalMin += row.totalMinutes * planScale;
        });

        const allCats = [...new Set([...Object.keys(gaps.breakdown), ...Object.keys(planBreakdown)])];
        const comparisonData = allCats.map((cat) => {
            const plan = planBreakdown[cat] || { minutes: 0, km: 0 };
            const exec = gaps.breakdown[cat] || { minutes: 0, km: 0 };
            const planPct = planTotalMin > 0 ? (plan.minutes / planTotalMin) * 100 : 0;
            const execPct = gaps.summary.totalMinutes > 0 ? (exec.minutes / gaps.summary.totalMinutes) * 100 : 0;
            return {
                'קטגוריה': cat,
                'תכנון_דקות': Math.round(plan.minutes),
                'תכנון_קמ': plan.km.toFixed(1),
                'תכנון_%': `${planPct.toFixed(1)}%`,
                'ביצוע_דקות': Math.round(exec.minutes),
                'ביצוע_קמ': exec.km.toFixed(1),
                'ביצוע_%': `${execPct.toFixed(1)}%`,
                'פער_דקות': Math.round(exec.minutes - plan.minutes),
                'פער_קמ': (exec.km - plan.km).toFixed(1),
                'פער_%': `${(execPct - planPct).toFixed(1)}%`
            };
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(comparisonData), 'השוואה_תכנון_ביצוע');
    }

    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(Object.entries(gaps.breakdown).map(([cat, data]) => ({
        'קטגוריה': cat,
        'דקות': Math.round(data.minutes),
        'שעות': (data.minutes / 60).toFixed(1),
        '%': gaps.summary.totalMinutes > 0 ? `${(data.minutes / gaps.summary.totalMinutes * 100).toFixed(1)}%` : '0%',
        'תוספת_דק_קמ': gaps.summary.totalPtKm > 0 ? (data.minutes / gaps.summary.totalPtKm).toFixed(2) : '0.00'
    }))), 'פילוח_ביצוע');

    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(filteredExec.map((row) => ({
        'תאריך': row.date,
        'נהג': row.driver,
        'דקות_כולל': row.totalMinutes,
        'דקות_תחצ': row.ptMinutes,
        'קמ_תחצ': row.ptKm,
        'דקות_לקמ': row.minPerKm,
        '%_תחצ': row.ptPercent,
        'סטטוס': row.status
    }))), 'נהגים');

    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(gaps.lowDrivers.map((row) => ({
        'תאריך': row.date,
        'נהג': row.driver,
        'דקות_כולל': row.totalMinutes,
        'דקות_תחצ': row.ptMinutes,
        '%_תחצ': row.ptPercent,
        'פער': (75 - row.ptPercent).toFixed(1)
    }))), 'מתחת_75');

    if (STATE.planResults.length > 0) {
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(STATE.planResults.map((row) => ({
            'סידור': row.dutyId,
            'דקות_כולל': Math.round(row.totalMinutes * planScale),
            'דקות_תחצ': Math.round(row.ptMinutes * planScale),
            'קמ_תחצ': Math.round(row.ptKm * planScale * 100) / 100,
            'דקות_לקמ': row.minPerKm,
            '%_תחצ': row.ptPercent
        }))), 'תכנון');
    }

    XLSX.writeFile(wb, 'efficiency_analysis.xlsx');
};

const downloadHTML = () => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([document.documentElement.outerHTML], { type: 'text/html' }));
    a.download = 'efficiency_report.html';
    a.click();
};

['exec-zone', 'plan-zone'].forEach((id) => {
    const zone = document.getElementById(id);
    const type = id.split('-')[0];
    zone.addEventListener('dragover', (event) => { event.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', (event) => {
        event.preventDefault();
        zone.classList.remove('dragover');
        if (event.dataTransfer.files[0]) {
            document.getElementById(`${type}-file`).files = event.dataTransfer.files;
            handleFile(document.getElementById(`${type}-file`), type);
        }
    });
});

document.addEventListener('keydown', (event) => { if (event.key === 'Escape') closeModal(); });
</script>
</body>
</html>
